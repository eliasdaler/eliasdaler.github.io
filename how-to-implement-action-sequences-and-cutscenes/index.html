<!DOCTYPE html>
<html lang="en-us">
  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      How to implement action sequences and cutscenes &middot; Elias Daler's blog
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="/public/css/videoWrapper.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">
  <link rel="stylesheet" href="/css/main.css">

  <!-- Icons -->
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>

  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">

  <div class="sidebar-item">
    <h4 style="color:#FFFFFF;"><i class="fa fa-gamepad fa-3x" aria-hidden="true"></i><br>Elias Daler's blog
</h4>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/"><i class="fa fa-home fa-fw" aria-hidden="true"></i>&nbsp; Home</a>
    <a class="sidebar-nav-item" href="/re-creation/"><i class="fa fa-gamepad fa-fw" aria-hidden="true"></i>&nbsp; Re:creation</a>
    <a class="sidebar-nav-item" href="/programming-and-gamedev-resources/"><i class="fa fa-list-ul fa-fw" aria-hidden="true"></i>&nbsp; Programming and game dev resources</a>
    <a class="sidebar-nav-item" href="/about/"><i class="fa fa-user fa-fw" aria-hidden="true"></i>&nbsp; About</a>
    <a class="sidebar-nav-item" href="/tags/"><i class="fa fa-tags fa-fw" aria-hidden="true"></i>&nbsp; Tags</a>
  </nav>

  <div class="sidebar-item">
    <h5 style="color:#FFFFFF;">
      &copy; 2021. Elias Daler. All rights reserved.
    </h5>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Elias Daler's blog</a>
            <small></small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">How to implement action sequences and cutscenes</h1>
    <span class="post-meta"><time datetime="2018-10-03T21:00:00+03:00" itemprop="datePublished"><i class="fa fa-calendar" aria-hidden="true"></i> Posted on <b>Oct 3, 2018</b></time></span>
<ul class="tags">
  
    <li><a href="/tags#C%2B%2B" class="tag"><i class="fa fa-tag" aria-hidden="true"></i> C++</a></li>
  
    <li><a href="/tags#Lua" class="tag"><i class="fa fa-tag" aria-hidden="true"></i> Lua</a></li>
  
    <li><a href="/tags#game+dev" class="tag"><i class="fa fa-tag" aria-hidden="true"></i> game dev</a></li>
  
</ul>
  </header>
  <hr>

  <div class="post-content" itemprop="articleBody">
    
<hr />

<h2 id="introduction">Introduction</h2>

<p><a href="https://habr.com/post/427135/">Russian translation</a></p>

<p>This post will show ways of implementing actions sequences and cutscenes in video games. The code is written in Lua, but the patterns can be implemented with other languages (except the coroutine approach, because not all languages have coroutines).</p>

<p>Action sequences frequently appear in games. In cutscenes, for example: a character approaches an enemy, says something, the enemy responds and so on. But action sequences often appear in gameplay as well. Take a look at this gif for example:</p>

<p><img src="/assets/cutscene_article/going_into_bar.gif" alt="Sample cutscene" style="display:block; margin: 0 auto; width: 480px" /></p>

<!--more-->
<p><a class="anchor" id="read-more"></a></p>

<p>We see the following sequence of actions:</p>

<ol>
  <li>The door is opened</li>
  <li>The player goes inside the house</li>
  <li>The door closes</li>
  <li>The screen fades out</li>
  <li>Level changes</li>
  <li>The screen fades in</li>
  <li>The player enters the building</li>
</ol>

<p>Action sequences can be used when scripting NPC behavior and boss fights. For example, you can have a boss throw something at you, then laugh, then shook its fist in your direction. But implementing such things is not an easy task…</p>

<h2 class="no_toc" id="table-of-contents">Table of contents</h2>

<ul id="markdown-toc">
  <li><a href="#introduction" id="markdown-toc-introduction">Introduction</a></li>
  <li><a href="#the-problem" id="markdown-toc-the-problem">The problem</a></li>
  <li><a href="#booleans-enums-state-machines" id="markdown-toc-booleans-enums-state-machines">Booleans, enums, state machines</a></li>
  <li><a href="#action-lists" id="markdown-toc-action-lists">Action lists</a></li>
  <li><a href="#coroutines" id="markdown-toc-coroutines">Coroutines</a>    <ul>
      <li><a href="#coroutines-basics" id="markdown-toc-coroutines-basics">Coroutines basics</a></li>
      <li><a href="#implementing-cutscenes-with-coroutines" id="markdown-toc-implementing-cutscenes-with-coroutines">Implementing cutscenes with coroutines</a></li>
      <li><a href="#advanced-usage" id="markdown-toc-advanced-usage">Advanced usage</a></li>
      <li><a href="#pros-and-cons-of-coroutines" id="markdown-toc-pros-and-cons-of-coroutines">Pros and cons of coroutines</a></li>
    </ul>
  </li>
  <li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li>
</ul>

<h2 id="the-problem">The problem</h2>

<p>Unfortunately, standard game loop doesn’t make it easy for us. Suppose we have this game loop:</p>

<p><img src="/assets/cutscene_article/game_loop.png" alt="Dialogue" style="display:block; margin: 0 auto; width: 256px" /></p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">while</span> <span class="n">game</span><span class="p">:</span><span class="n">isRunning</span><span class="p">()</span> <span class="k">do</span>
  <span class="n">processInput</span><span class="p">()</span>
  <span class="n">dt</span> <span class="o">=</span> <span class="n">clock</span><span class="p">.</span><span class="n">delta</span><span class="p">()</span>
  <span class="n">update</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
  <span class="n">render</span><span class="p">()</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Now, suppose you want to implement the following cutscene: a player goes to an NPC, and the NPC says “You did it!”, and then after short delay it says “Thank you!”. In ideal world, we’d want to write it like this:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">player</span><span class="p">:</span><span class="n">goTo</span><span class="p">(</span><span class="n">npc</span><span class="p">)</span>
<span class="n">npc</span><span class="p">:</span><span class="n">say</span><span class="p">(</span><span class="s2">"You did it!"</span><span class="p">)</span>
<span class="n">delay</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span>
<span class="n">npc</span><span class="p">:</span><span class="n">say</span><span class="p">(</span><span class="s2">"Thank you"</span><span class="p">)</span>
</code></pre></div></div>

<p>And that’s when we hit the first roadblock. All these actions take some time to complete. Some might even require user input - for example, to close a dialogue window before the cutscene can proceed further. As for <code class="highlighter-rouge">delay</code>, you can’t just call <code class="highlighter-rouge">sleep</code> function there, because the game will freeze. It won’t be updated and will be stuck in one iteration of the game loop.</p>

<p>Let’s take a look at some of the possible solutions to the problem.</p>

<h2 id="booleans-enums-state-machines">Booleans, enums, state machines</h2>

<p>The most obvious and brute-force way to implement action sequence is to store the information about its state in booleans, strings or enums. The code will look something like this:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nf">update</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">cutsceneState</span> <span class="o">==</span> <span class="s1">'playerGoingToNpc'</span> <span class="k">then</span>
    <span class="n">player</span><span class="p">:</span><span class="n">continueGoingTo</span><span class="p">(</span><span class="n">npc</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">player</span><span class="p">:</span><span class="n">closeTo</span><span class="p">(</span><span class="n">npc</span><span class="p">)</span> <span class="k">then</span>
      <span class="n">cutsceneState</span> <span class="o">=</span> <span class="s1">'npcSayingYouDidIt'</span>
      <span class="n">dialogueWindow</span><span class="p">:</span><span class="n">show</span><span class="p">(</span><span class="s2">"You did it!"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">elseif</span> <span class="n">cutsceneState</span> <span class="o">==</span> <span class="s1">'npcSayingYouDidIt'</span> <span class="k">then</span>
    <span class="k">if</span> <span class="n">dialogueWindow</span><span class="p">:</span><span class="n">wasClosed</span><span class="p">()</span> <span class="k">then</span>
      <span class="n">cutsceneState</span> <span class="o">=</span> <span class="s1">'delay'</span>
    <span class="k">end</span>
  <span class="k">elseif</span> <span class="o">...</span>
    <span class="o">...</span> <span class="c1">-- so on...</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This approach can easily lead to spaghetti code and long if-else chains, so I’d recommend to avoid it.</p>

<h2 id="action-lists">Action lists</h2>

<p>Action lists are similar to state machines. Action list is a list of actions which are executed sequentially. You can think of an action as a state in state machine. We update the current action in every iteration of game loop. If we see that the action has finished, we move on to the next one.</p>

<p>In our example, we can implement the following actions: <code class="highlighter-rouge">GoToAction</code>, <code class="highlighter-rouge">DialogueAction</code> and <code class="highlighter-rouge">DelayAction</code>. Let’s look at the implementation of <code class="highlighter-rouge">DelayAction</code>.</p>

<p class="message">For examples I’ll use <i class="fa fa-github"></i> <a href="https://github.com/kikito/middleclass">middleclass</a> library for OOP.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- constructor</span>
<span class="k">function</span> <span class="nf">DelayAction</span><span class="p">:</span><span class="n">initialize</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">params</span><span class="p">.</span><span class="n">delay</span>

  <span class="n">self</span><span class="p">.</span><span class="n">currentTime</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">self</span><span class="p">.</span><span class="n">isFinished</span> <span class="o">=</span> <span class="kc">false</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">DelayAction</span><span class="p">:</span><span class="n">update</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">currentTime</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">currentTime</span> <span class="o">+</span> <span class="n">dt</span>
  <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">currentTime</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">delay</span> <span class="k">then</span>
    <span class="n">self</span><span class="p">.</span><span class="n">isFinished</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">ActionList</code>’s <code class="highlighter-rouge">update</code> function looks like this:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nf">ActionList</span><span class="p">:</span><span class="n">update</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">isFinished</span> <span class="k">then</span>
    <span class="n">self</span><span class="p">.</span><span class="n">currentAction</span><span class="p">:</span><span class="n">update</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">currentAction</span><span class="p">.</span><span class="n">isFinished</span> <span class="k">then</span>
      <span class="n">self</span><span class="p">:</span><span class="n">goToNextAction</span><span class="p">()</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">currentAction</span> <span class="k">then</span>
        <span class="n">self</span><span class="p">.</span><span class="n">isFinished</span> <span class="o">=</span> <span class="kc">true</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>And finally, our cutscene looks like this:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nf">makeCutsceneActionList</span><span class="p">(</span><span class="n">player</span><span class="p">,</span> <span class="n">npc</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">ActionList</span><span class="p">:</span><span class="n">new</span> <span class="p">{</span>
    <span class="n">GoToAction</span><span class="p">:</span><span class="n">new</span> <span class="p">{</span>
      <span class="n">entity</span> <span class="o">=</span> <span class="n">player</span><span class="p">,</span>
      <span class="n">target</span> <span class="o">=</span> <span class="n">npc</span>
    <span class="p">},</span>
    <span class="n">SayAction</span><span class="p">:</span><span class="n">new</span> <span class="p">{</span>
      <span class="n">entity</span> <span class="o">=</span> <span class="n">npc</span><span class="p">,</span>
      <span class="n">text</span> <span class="o">=</span> <span class="s2">"You did it!"</span>
    <span class="p">},</span>
    <span class="n">DelayAction</span><span class="p">:</span><span class="n">new</span> <span class="p">{</span>
      <span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span>
    <span class="p">},</span>
    <span class="n">SayAction</span><span class="p">:</span><span class="n">new</span> <span class="p">{</span>
      <span class="n">entity</span> <span class="o">=</span> <span class="n">npc</span><span class="p">,</span>
      <span class="n">text</span> <span class="o">=</span> <span class="s2">"Thank you"</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="k">end</span>

<span class="c1">-- ... and then somewhere in update:</span>
<span class="n">actionList</span><span class="p">:</span><span class="n">update</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
</code></pre></div></div>

<p class="message">In Lua <code>someFunction({ ... })</code> can be written as <code>someFunction{...}</code>, that’s why instead of writing <code>DelayAction:new({delay = 0.5})</code> we can write <code>DelayAction:new{ delay = 0.5 }</code>.</p>

<p>This looks much better. We now have a clear sequence of actions. If we want to insert new action in a cutscene, we can easily do so. And we can reuse common actions in lots of action sequences.</p>

<p>See this presentation by Sean Middleditch for more details and trickier usages of action lists:</p>

<div class="videoWrapper">
  <iframe width="496" height="372" src="https://www.youtube.com/embed/o6CaB-hmqoE" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen=""></iframe>
</div>

<p>Action lists are very useful. I’ve used them for several years before discovering coroutine approach and was very happy. But then I wanted to make more complex cutscenes like this:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="k">function</span> <span class="nf">cutscene</span><span class="p">(</span><span class="n">player</span><span class="p">,</span> <span class="n">npc</span><span class="p">)</span>
  <span class="n">player</span><span class="p">:</span><span class="n">goTo</span><span class="p">(</span><span class="n">npc</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">player</span><span class="p">:</span><span class="n">hasCompleted</span><span class="p">(</span><span class="n">quest</span><span class="p">)</span> <span class="k">then</span>
    <span class="n">npc</span><span class="p">:</span><span class="n">say</span><span class="p">(</span><span class="s2">"You did it!"</span><span class="p">)</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">npc</span><span class="p">:</span><span class="n">say</span><span class="p">(</span><span class="s2">"Thank you"</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="n">npc</span><span class="p">:</span><span class="n">say</span><span class="p">(</span><span class="s2">"Please help me"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>With action lists you’ll need non-linear lists to make this happen. This can be accomplished by actions having tags. Then, you’ll be able to jump to a tagged action instead of the next one. This works, but it is not as readable as the function above.</p>

<p>We can make this code real with coroutines.</p>

<h2 id="coroutines">Coroutines</h2>

<h3 id="coroutines-basics">Coroutines basics</h3>

<p>Coroutine is a function which can be “paused” and “resumed”. It is executed in <strong>the same thread</strong> as your main program. No new threads are created for it.</p>

<p>Coroutines can be paused with <code class="highlighter-rouge">coroutine.yield</code> and resumed with <code class="highlighter-rouge">coroutine.resume</code>. Here’s a simple example:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="k">function</span> <span class="nf">f</span><span class="p">()</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">"hello"</span><span class="p">)</span>
  <span class="nb">coroutine.yield</span><span class="p">()</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">"world!"</span><span class="p">)</span>
<span class="k">end</span>

<span class="kd">local</span> <span class="n">c</span> <span class="o">=</span> <span class="nb">coroutine.create</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="nb">coroutine.resume</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"uhh..."</span><span class="p">)</span>
<span class="nb">coroutine.resume</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</code></pre></div></div>

<p>The output is:</p>

<p class="console-output">hello
uhh…
world</p>

<p>First we create a coroutine with <code class="highlighter-rouge">coroutine.create</code>. Coroutine doesn’t start to execute after it’s created. It needs to be launched by <code class="highlighter-rouge">coroutine.resume</code>. <code class="highlighter-rouge">f</code> function is called then, it prints “hello” and then pauses itself by yielding. You can think of it as a form of <code class="highlighter-rouge">return</code>, but we can still resume the function afterwards by calling <code class="highlighter-rouge">coroutine.resume</code> if coroutine hasn’t finished its function.</p>

<p>If you pass arguments when calling <code class="highlighter-rouge">coroutine.yield</code>, they’re returned by <code class="highlighter-rouge">coroutine.resume</code> in the “main thread”. For example:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="k">function</span> <span class="nf">f</span><span class="p">()</span>
    <span class="o">...</span>
    <span class="nb">coroutine.yield</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="s2">"some text"</span><span class="p">)</span>
    <span class="o">...</span>
<span class="k">end</span>

<span class="n">ok</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="nb">coroutine.resume</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span> <span class="c1">-- will print '42    "some text"'</span>
</code></pre></div></div>

<p>Here, <code class="highlighter-rouge">ok</code> is a bool, which shows the status of coroutine. If <code class="highlighter-rouge">ok</code> is <code class="highlighter-rouge">true</code> then everything is okay and next returned values are arguments of the last <code class="highlighter-rouge">coroutine.yield</code> call. However, if <code class="highlighter-rouge">f</code> calls <code class="highlighter-rouge">error</code> function or fails at some point, the first value will be <code class="highlighter-rouge">false</code> and the error message will be the second return of the function. Let’s see a failing coroutine:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="k">function</span> <span class="nf">f</span><span class="p">()</span>
  <span class="nb">print</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">notDefined</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">c</span> <span class="o">=</span> <span class="nb">coroutine.create</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="n">ok</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="nb">coroutine.resume</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="k">then</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Coroutine failed!"</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>
<p>Output:</p>
<p class="console-output">Coroutine failed!    input:4: attempt to perform arithmetic on a nil value (global ‘notDefined’)</p>

<p>Similarly, you can pass values to a coroutine when calling <code class="highlighter-rouge">coroutine.resume</code> and the results will be returned by <code class="highlighter-rouge">coroutine.yield</code>:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="k">function</span> <span class="nf">f</span><span class="p">()</span>
    <span class="o">...</span>
    <span class="n">someNum</span> <span class="o">=</span> <span class="nb">coroutine.yield</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">someNum</span><span class="p">)</span> <span class="c1">-- will print "42"</span>
    <span class="o">...</span>
<span class="k">end</span>

<span class="o">...</span>
<span class="nb">coroutine.resume</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">42</span><span class="p">)</span>
</code></pre></div></div>

<p>Coroutine can be in different states which you can check by calling <code class="highlighter-rouge">coroutine.status</code>:</p>

<ul>
  <li><code class="highlighter-rouge">"running"</code> - coroutine is currently running. This means that <code class="highlighter-rouge">coroutine.status</code> was launched from inside the coroutine’s function.</li>
  <li><code class="highlighter-rouge">"suspended"</code> - coroutine was paused or hasn’t been launched yet.</li>
  <li><code class="highlighter-rouge">"normal"</code> - coroutine is active, but isn’t currently running (it has resumed another coroutine).</li>
  <li><code class="highlighter-rouge">"dead"</code> - the coroutine has finished running - function has finished its execution.</li>
</ul>

<p>Now, let’s implement coroutine-based action sequence system with this knowledge.</p>

<h3 id="implementing-cutscenes-with-coroutines">Implementing cutscenes with coroutines</h3>

<p>Here’s how our basic action will look like:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nf">Action</span><span class="p">:</span><span class="n">launch</span><span class="p">()</span>
  <span class="n">self</span><span class="p">:</span><span class="n">init</span><span class="p">()</span>

  <span class="k">while</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">finished</span> <span class="k">do</span>
    <span class="kd">local</span> <span class="n">dt</span> <span class="o">=</span> <span class="nb">coroutine.yield</span><span class="p">()</span> <span class="c1">-- the most important part</span>
    <span class="n">self</span><span class="p">:</span><span class="n">update</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">self</span><span class="p">:</span><span class="n">exit</span><span class="p">()</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This is similar to what we have with action lists: the action calls <code class="highlighter-rouge">update</code> function until it’s finished. But it yields on each game loop iteration (<code class="highlighter-rouge">Action:launch</code> is called from some coroutine), while somewhere in our main <code class="highlighter-rouge">update</code> (for example, in some <code class="highlighter-rouge">ActionSequenceManager</code> which tracks the state of all action sequences) we resume it like this:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">coroutine.resume</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span> <span class="c1">-- note that we pass dt here</span>
                        <span class="c1">-- which is later used in actions's update</span>
</code></pre></div></div>

<p>Our cutscene is a coroutine now:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nf">cutscene</span><span class="p">(</span><span class="n">player</span><span class="p">,</span> <span class="n">npc</span><span class="p">)</span>
  <span class="n">player</span><span class="p">:</span><span class="n">goTo</span><span class="p">(</span><span class="n">npc</span><span class="p">)</span>
  <span class="n">npc</span><span class="p">:</span><span class="n">say</span><span class="p">(</span><span class="s2">"You did it!"</span><span class="p">)</span>
  <span class="n">delay</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span>
  <span class="n">npc</span><span class="p">:</span><span class="n">say</span><span class="p">(</span><span class="s2">"Thank you"</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1">-- later...</span>
<span class="kd">local</span> <span class="n">c</span> <span class="o">=</span> <span class="nb">coroutine.create</span><span class="p">(</span><span class="n">cutscene</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">npc</span><span class="p">)</span>
<span class="nb">coroutine.resume</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
</code></pre></div></div>

<p>Here’s how <code class="highlighter-rouge">delay</code> is implemented:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nf">delay</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
    <span class="n">action</span> <span class="o">=</span> <span class="n">DelayAction</span><span class="p">:</span><span class="n">new</span> <span class="p">{</span> <span class="n">delay</span> <span class="o">=</span> <span class="n">time</span> <span class="p">}</span>
    <span class="n">action</span><span class="p">:</span><span class="n">launch</span><span class="p">()</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Having such wrapper functions is very useful to make your cutscenes easier to read and use. Next, let’s see how <code class="highlighter-rouge">DelayAction</code> is implemented:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Action is a base class of DelayAction</span>
<span class="kd">local</span> <span class="n">DelayAction</span> <span class="o">=</span> <span class="n">class</span><span class="p">(</span><span class="s2">"DelayAction"</span><span class="p">,</span> <span class="n">Action</span><span class="p">)</span>

<span class="k">function</span> <span class="nf">DelayAction</span><span class="p">:</span><span class="n">initialize</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">params</span><span class="p">.</span><span class="n">delay</span>
  <span class="n">self</span><span class="p">.</span><span class="n">currentTime</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">self</span><span class="p">.</span><span class="n">isFinished</span> <span class="o">=</span> <span class="kc">false</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">DelayAction</span><span class="p">:</span><span class="n">update</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">currentTime</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">currentTime</span> <span class="o">+</span> <span class="n">dt</span>
  <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">currentTime</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">delayTime</span> <span class="k">then</span>
    <span class="n">self</span><span class="p">.</span><span class="n">finished</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This is identical to action lists approach! Let’s take a look at <code class="highlighter-rouge">Action</code>’s <code class="highlighter-rouge">launch</code> function again to understand how it works:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nf">Action</span><span class="p">:</span><span class="n">launch</span><span class="p">()</span>
  <span class="n">self</span><span class="p">:</span><span class="n">init</span><span class="p">()</span>

  <span class="k">while</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">finished</span> <span class="k">do</span>
    <span class="kd">local</span> <span class="n">dt</span> <span class="o">=</span> <span class="nb">coroutine.yield</span><span class="p">()</span> <span class="c1">-- the most important part</span>
    <span class="n">self</span><span class="p">:</span><span class="n">update</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">self</span><span class="p">:</span><span class="n">exit</span><span class="p">()</span>
<span class="k">end</span>
</code></pre></div></div>

<p>As you can see, we can create <code class="highlighter-rouge">init</code> and <code class="highlighter-rouge">exit</code> functions to do something when action begins and ends. But the most important part is the <code class="highlighter-rouge">while</code> loop which executes until the action is finished. Here’s a visualization of the order of execution which makes it easier to understand:</p>

<p><img src="/assets/cutscene_article/coroutine_game_loop.png" alt="Dialogue" style="display:block; margin: 0 auto; width: 480px" /></p>

<p>Now, let’s see how we can implement <code class="highlighter-rouge">goTo</code> function:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nf">Entity</span><span class="p">:</span><span class="n">goTo</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">action</span> <span class="o">=</span> <span class="n">GoToAction</span><span class="p">:</span><span class="n">new</span> <span class="p">{</span> <span class="n">entity</span> <span class="o">=</span> <span class="n">self</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">target</span> <span class="p">}</span>
    <span class="n">action</span><span class="p">:</span><span class="n">launch</span><span class="p">()</span>
<span class="k">end</span>

<span class="c1">-- constructor is ommited</span>

<span class="k">function</span> <span class="nf">GoToAction</span><span class="p">:</span><span class="n">update</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">entity</span><span class="p">:</span><span class="n">closeTo</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">target</span><span class="p">)</span> <span class="k">then</span>
      <span class="o">...</span> <span class="c1">-- perform AI movement logic here</span>
    <span class="k">else</span>
      <span class="n">self</span><span class="p">.</span><span class="n">finished</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>It’s very easy to implement new types of actions.</p>

<p>Now, let’s see how we can use coroutines with events. Let’s implement <code class="highlighter-rouge">WaitForEventAction</code>:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nf">WaitForEventAction</span><span class="p">:</span><span class="n">initialize</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">finished</span> <span class="o">=</span> <span class="kc">false</span>

  <span class="n">eventManager</span><span class="p">:</span><span class="n">subscribe</span> <span class="p">{</span>
    <span class="n">listener</span> <span class="o">=</span> <span class="n">self</span><span class="p">,</span>
    <span class="n">eventType</span> <span class="o">=</span> <span class="n">params</span><span class="p">.</span><span class="n">eventType</span><span class="p">,</span>
    <span class="n">callback</span> <span class="o">=</span> <span class="n">WaitForEventAction</span><span class="p">.</span><span class="n">onEvent</span>
  <span class="p">}</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">WaitForEventAction</span><span class="p">:</span><span class="n">onEvent</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">finished</span> <span class="o">=</span> <span class="kc">true</span>
<span class="k">end</span>
</code></pre></div></div>

<p>We can leave the <code class="highlighter-rouge">update</code> function empty for that one. This action will execute until an event of <code class="highlighter-rouge">eventType</code> is sent. As a practical example of <code class="highlighter-rouge">WaitForEventAction</code> usage, let’s implement <code class="highlighter-rouge">say</code> function:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nf">Entity</span><span class="p">:</span><span class="n">say</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">DialogueWindow</span><span class="p">:</span><span class="n">show</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">action</span> <span class="o">=</span> <span class="n">WaitForEventAction</span><span class="p">:</span><span class="n">new</span> <span class="p">{</span>
      <span class="n">eventType</span> <span class="o">=</span> <span class="s1">'DialogueWindowClosed'</span>
    <span class="p">}</span>
    <span class="n">action</span><span class="p">:</span><span class="n">launch</span><span class="p">()</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Nice and easy. Now, when dialogue window is closed by the player by the press of the button, it will send <code class="highlighter-rouge">DialogueWindowClosed</code> event. The action will finish and the next one will start.</p>

<p>It’s easy to implement non-linear cutscenes, which depend on player’s choice, for example:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">answer</span> <span class="o">=</span> <span class="n">girl</span><span class="p">:</span><span class="n">say</span><span class="p">(</span><span class="s1">'do_you_love_lua'</span><span class="p">,</span>
                          <span class="p">{</span> <span class="s1">'YES'</span><span class="p">,</span> <span class="s1">'NO'</span> <span class="p">})</span>
<span class="k">if</span> <span class="n">answer</span> <span class="o">==</span> <span class="s1">'YES'</span> <span class="k">then</span>
  <span class="n">girl</span><span class="p">:</span><span class="n">setMood</span><span class="p">(</span><span class="s1">'happy'</span><span class="p">)</span>
  <span class="n">girl</span><span class="p">:</span><span class="n">say</span><span class="p">(</span><span class="s1">'happy_response'</span><span class="p">)</span>
<span class="k">else</span>
  <span class="n">girl</span><span class="p">:</span><span class="n">setMood</span><span class="p">(</span><span class="s1">'angry'</span><span class="p">)</span>
  <span class="n">girl</span><span class="p">:</span><span class="n">say</span><span class="p">(</span><span class="s1">'angry_response'</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p><img src="/assets/cutscene_article/dialogue.gif" alt="Dialogue" style="display:block; margin: 0 auto; width: 480px" /></p>

<p>The implementation of <code class="highlighter-rouge">say</code> function is trickier there, because now you need to somehow return player’s dialogue choice, but it’s not that hard to implement. As you can see, we don’t need to implement special mechanisms for if-else statements and loops.</p>

<h3 id="advanced-usage">Advanced usage</h3>

<p>It’s easy to make quests and tutorials using coroutines. Consider this function:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">girl</span><span class="p">:</span><span class="n">say</span><span class="p">(</span><span class="s2">"Kill that monster!"</span><span class="p">)</span>
<span class="n">waitForEvent</span><span class="p">(</span><span class="s1">'EnemyKilled'</span><span class="p">)</span>
<span class="n">girl</span><span class="p">:</span><span class="n">setMood</span><span class="p">(</span><span class="s1">'happy'</span><span class="p">)</span>
<span class="n">girl</span><span class="p">:</span><span class="n">say</span><span class="p">(</span><span class="s2">"You did it! Thank you!"</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/assets/cutscene_article/kill_monster_quest.gif" alt="Kill monster quest" style="display:block; margin: 0 auto; width: 480px" /></p>

<p>You can also use coroutines for AI. For example, to make a monster traverse a path, you can do this:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nf">followPath</span><span class="p">(</span><span class="n">monster</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">numberOfPoints</span> <span class="o">=</span> <span class="n">path</span><span class="p">:</span><span class="n">getNumberOfPoints</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">-- index of current waypoint on path</span>
  <span class="k">while</span> <span class="kc">true</span> <span class="k">do</span>
    <span class="n">monster</span><span class="p">:</span><span class="n">goTo</span><span class="p">(</span><span class="n">path</span><span class="p">:</span><span class="n">getPoint</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numberOfPoints</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">then</span>
      <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1">-- go to the next point</span>
    <span class="k">else</span> <span class="c1">-- start from the beginning</span>
      <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p><img src="/assets/cutscene_article/monster_follows_path.gif" alt="Monster following a path" style="display:block; margin: 0 auto; width: 240px" /></p>

<p>When monster will see the player, we can just not resume the coroutine, so while that <code class="highlighter-rouge">while</code> loop looks endless, it isn’t.</p>

<p>It’s also possible to implement “parallel” actions in a way that both actions are performed at the same time, but the action sequence goes to next action only when both actions are finished. For example, consider two NPCs moving at different speeds. When they meet at <code class="highlighter-rouge">meetingPoint</code>, the cat says “meow”. We can implement it like this:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nf">cutscene</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="n">girl</span><span class="p">,</span> <span class="n">meetingPoint</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">c1</span> <span class="o">=</span> <span class="nb">coroutine.create</span><span class="p">(</span>
    <span class="k">function</span><span class="p">()</span>
      <span class="n">cat</span><span class="p">:</span><span class="n">goTo</span><span class="p">(</span><span class="n">meetingPoint</span><span class="p">)</span>
    <span class="k">end</span><span class="p">)</span>

  <span class="kd">local</span> <span class="n">c2</span> <span class="o">=</span> <span class="nb">coroutine.create</span><span class="p">(</span>
    <span class="k">function</span><span class="p">()</span>
      <span class="n">girl</span><span class="p">:</span><span class="n">goTo</span><span class="p">(</span><span class="n">meetingPoint</span><span class="p">)</span>
    <span class="k">end</span><span class="p">)</span>

  <span class="n">c1</span><span class="p">.</span><span class="n">resume</span><span class="p">()</span>
  <span class="n">c2</span><span class="p">.</span><span class="n">resume</span><span class="p">()</span>

  <span class="c1">-- synchronization</span>
  <span class="n">waitForFinish</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>

  <span class="c1">-- cutscene continues</span>
  <span class="n">cat</span><span class="p">:</span><span class="n">say</span><span class="p">(</span><span class="s2">"meow"</span><span class="p">)</span>
  <span class="o">...</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The important part here is <code class="highlighter-rouge">waitForFinish</code> function which is a wrapper around <code class="highlighter-rouge">WaitForFinishAction</code> which can be implemented like this:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nf">WaitForFinishAction</span><span class="p">:</span><span class="n">update</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">coroutine.status</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">c1</span><span class="p">)</span> <span class="o">==</span> <span class="s1">'dead'</span> <span class="ow">and</span>
     <span class="nb">coroutine.status</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">c2</span><span class="p">)</span> <span class="o">==</span> <span class="s1">'dead'</span> <span class="k">then</span>
     <span class="n">self</span><span class="p">.</span><span class="n">finished</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="k">else</span>
    <span class="k">if</span> <span class="nb">coroutine.status</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">c1</span><span class="p">)</span> <span class="o">~=</span> <span class="s1">'dead'</span> <span class="k">then</span>
      <span class="nb">coroutine.resume</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">c1</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">if</span> <span class="nb">coroutine.status</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">c2</span><span class="p">)</span> <span class="o">~=</span> <span class="s1">'dead'</span> <span class="k">then</span>
      <span class="nb">coroutine.resume</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">c2</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>You can also take it a step further and allow <code class="highlighter-rouge">WaitForFinishAction</code> to take an arbitrary amount of actions to synchronize. You can also implement an action which waits until one of the actions is finished. For example, this can be used for racing mini-games. You’ll be able to check when one of the cars arrives the finish line and then execute some action sequence.</p>

<h3 id="pros-and-cons-of-coroutines">Pros and cons of coroutines</h3>

<p>Coroutine approach is very powerful. The action sequences and cutscenes written with it can be easily read and modified, even by non-programmers.</p>

<p>What’s also great is about it is that everything happens in one thread, so you don’t have synchronization or data racing problems.</p>

<p>The approach is not perfect, however. For example, it’s hard to handle saving. For example, suppose that you have a long tutorial which is just one big coroutine. The player won’t be able to save during this tutorial, because you’d have to serialize coroutine’s state and then resume coroutine exactly from the point it was paused at.</p>

<p class="message">It’s possible to save coroutine’s state with <a href="http://lua-users.org/wiki/PlutoLibrary">PlutoLibrary</a>, however it only works with Lua 5.1</p>

<p>This is not a problem if you use coroutines for cutscenes, as it’s usually not allowed for player to save during them.</p>

<p>As for the long tutorial example - you can just separate your tutorial in chunks and then allow player to only save between them. For example, part A of the tutorial happens in a room without a save point. Then, there’s another room with a save point to which player goes once part A is finished. Then, part B begins. If you separate tutorial into two coroutines, serializing won’t be a problem, as you’ll only need to save a string which will contain info about the point of tutorial which player has completed.</p>

<h2 id="conclusion">Conclusion</h2>

<p>As you can see, there are different approaches to implementing actions sequences and cutscenes. I believe coroutine approach is one of the most useful and clearest for writing action sequences and cutscenes. I hope this approach will make your life easier and you’ll make tons of complex and fun cutscenes with it. Thanks for reading!</p>

    <hr />
    <p>Follow me on twitter <a href="https://twitter.com/EliasDaler">@EliasDaler</a> to not miss the new stuff!</p>
  </div>

</article>
<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        
        s.src = '//eliasdaler-github-io.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>

  </body>
</html>
