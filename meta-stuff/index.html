<!DOCTYPE html>
<html lang="en-us">
  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      How my little C++ meta-serialization library works and how I wrote it &middot; Elias Daler's blog
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="/public/css/videoWrapper.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">
  <link rel="stylesheet" href="/css/main.css">

  <!-- Icons -->
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>

  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">

  <div class="sidebar-item">
    <h4 style="color:#FFFFFF;"><i class="fa fa-gamepad fa-3x" aria-hidden="true"></i><br>Elias Daler's blog
</h4>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/"><i class="fa fa-home fa-fw" aria-hidden="true"></i>&nbsp; Home</a>
    <a class="sidebar-nav-item" href="/re-creation/"><i class="fa fa-gamepad fa-fw" aria-hidden="true"></i>&nbsp; Re:creation</a>
    <a class="sidebar-nav-item" href="/programming-and-gamedev-resources/"><i class="fa fa-list-ul fa-fw" aria-hidden="true"></i>&nbsp; Programming and game dev resources</a>
    <a class="sidebar-nav-item" href="/about/"><i class="fa fa-user fa-fw" aria-hidden="true"></i>&nbsp; About</a>
    <a class="sidebar-nav-item" href="/tags/"><i class="fa fa-tags fa-fw" aria-hidden="true"></i>&nbsp; Tags</a>
  </nav>

  <div class="sidebar-item">
    <h5 style="color:#FFFFFF;">
      &copy; 2021. Elias Daler. All rights reserved.
    </h5>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Elias Daler's blog</a>
            <small></small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">How my little C++ meta-serialization library works and how I wrote it</h1>
    <span class="post-meta"><time datetime="2017-09-27T22:00:00+03:00" itemprop="datePublished"><i class="fa fa-calendar" aria-hidden="true"></i> Posted on <b>Sep 27, 2017</b></time></span>
<ul class="tags">
  
    <li><a href="/tags#C%2B%2B" class="tag"><i class="fa fa-tag" aria-hidden="true"></i> C++</a></li>
  
</ul>
  </header>
  <hr>

  <div class="post-content" itemprop="articleBody">
    
<hr />

<h2 id="introduction">Introduction</h2>

<p>A year ago I wrote a small library called <i class="fa fa-github"></i><a href="https://github.com/eliasdaler/MetaStuff">MetaStuff</a>. It is used to register meta info about classes, which can be later used for serialization, deserialization, making GUI and so on. The cool thing about it is that you can write a serializer for your own data format, be it JSON, Lua or anything else. The library is very small, it uses C++14, requires no pre-build process, RTTI, macros… It’s just templates!</p>

<p>Let’s look at how registration and serialization work. Suppose you have the following struct:</p>

<pre class="vs-code"><span class="keyword">struct</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">Person</span>&nbsp;<span class="operator">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span>&nbsp;<span class="cppMemberField - identifier - (TRANSIENT)">age</span><span class="operator">;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppNamespace - identifier - (TRANSIENT)">std</span><span class="operator">::</span><span class="cppType - identifier - (TRANSIENT)">string</span>&nbsp;<span class="cppMemberField - identifier - (TRANSIENT)">name</span><span class="operator">;</span>
<span class="operator">};</span></pre>

<p>You register it like this:</p>

<pre class="vs-code"><span class="keyword">namespace</span>&nbsp;<span class="cppNamespace - identifier - (TRANSIENT)">meta</span>&nbsp;<span class="operator">{</span>

<span class="keyword">template</span>&nbsp;<span class="operator">&lt;&gt;</span>
<span class="keyword">inline</span>&nbsp;<span class="keyword">auto</span>&nbsp;<span class="cppFunction - identifier - (TRANSIENT)">registerMembers</span><span class="operator">&lt;</span><span class="cppType - identifier - (TRANSIENT)">Person</span><span class="operator">&gt;()</span>
<span class="operator">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span>&nbsp;<span class="cppFunctionTemplate - identifier - (TRANSIENT)">members</span><span class="operator">(</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppFunction - identifier - (TRANSIENT)">member</span><span class="operator">(</span><span class="string">&quot;age&quot;</span><span class="operator">,</span>&nbsp;<span class="operator">&amp;</span><span class="cppType - identifier - (TRANSIENT)">Person</span><span class="operator">::</span><span class="cppMemberField - identifier - (TRANSIENT)">age</span><span class="operator">),</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppFunction - identifier - (TRANSIENT)">member</span><span class="operator">(</span><span class="string">&quot;name&quot;</span><span class="operator">,</span>&nbsp;<span class="operator">&amp;</span><span class="cppType - identifier - (TRANSIENT)">Person</span><span class="operator">::</span><span class="cppMemberField - identifier - (TRANSIENT)">name</span><span class="operator">)</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">);</span>
<span class="operator">}</span>

<span class="operator">}</span>&nbsp;<span class="comment">//&nbsp;end&nbsp;of&nbsp;namespace&nbsp;meta</span></pre>

<p>And now you can serialize / deserialize it to / from JSON! (I’ll be using Niels Lohmann’s <i class="fa fa-github"></i><a href="https://github.com/nlohmann/json">JSON for Modern C++</a> library in this article)</p>

<pre class="vs-code"><span class="cppType - identifier - (TRANSIENT)">Person</span>&nbsp;<span class="cppLocalVariable - identifier - (TRANSIENT)">person</span><span class="operator">;</span>
<span class="cppLocalVariable - identifier - (TRANSIENT)">person</span><span class="operator">.</span><span class="cppMemberField - identifier - (TRANSIENT)">age</span>&nbsp;<span class="operator">=</span>&nbsp;<span class="number">30</span><span class="operator">;</span>
<span class="cppLocalVariable - identifier - (TRANSIENT)">person</span><span class="operator">.</span><span class="cppMemberField - identifier - (TRANSIENT)">name</span>&nbsp;<span class="cppMemberOperator - operator - (TRANSIENT)">=</span>&nbsp;<span class="string">&quot;John&quot;</span><span class="operator">;</span>

<span class="comment">//&nbsp;serialize</span>
<span class="cppType - identifier - (TRANSIENT)">json</span>&nbsp;<span class="cppLocalVariable - identifier - (TRANSIENT)">j</span><span class="operator">;</span>
<span class="cppLocalVariable - identifier - (TRANSIENT)">j</span>&nbsp;<span class="cppMemberOperator - operator - (TRANSIENT)">=</span>&nbsp;<span class="cppLocalVariable - identifier - (TRANSIENT)">person</span><span class="operator">;</span>

<span class="cppNamespace - identifier - (TRANSIENT)">std</span><span class="operator">::</span><span class="cppGlobalVariable - identifier - (TRANSIENT)">cout</span>&nbsp;<span class="cppOperator - operator - (TRANSIENT)">&lt;&lt;</span>&nbsp;<span class="cppNamespace - identifier - (TRANSIENT)">std</span><span class="operator">::</span><span class="cppFunction - identifier - (TRANSIENT)">setw</span><span class="operator">(</span><span class="number">4</span><span class="operator">)</span>&nbsp;<span class="cppOperator - operator - (TRANSIENT)">&lt;&lt;</span>&nbsp;<span class="cppLocalVariable - identifier - (TRANSIENT)">j</span>&nbsp;<span class="cppMemberOperator - operator - (TRANSIENT)">&lt;&lt;</span>&nbsp;<span class="cppNamespace - identifier - (TRANSIENT)">std</span><span class="operator">::</span><span class="cppFunctionTemplate - identifier - (TRANSIENT)">endl</span><span class="operator">;</span>

<span class="comment">//&nbsp;deserialize</span>
<span class="cppType - identifier - (TRANSIENT)">Person</span>&nbsp;<span class="cppLocalVariable - identifier - (TRANSIENT)">p2</span><span class="operator">;</span>
<span class="cppLocalVariable - identifier - (TRANSIENT)">p2</span>&nbsp;<span class="operator">=</span>&nbsp;<span class="cppLocalVariable - identifier - (TRANSIENT)">j</span><span class="operator">.</span><span class="identifier">get</span><span class="operator">&lt;</span><span class="cppType - identifier - (TRANSIENT)">Person</span><span class="operator">&gt;(</span><span class="cppLocalVariable - identifier - (TRANSIENT)">j</span><span class="operator">);</span>

<span class="cppNamespace - identifier - (TRANSIENT)">std</span><span class="operator">::</span><span class="cppGlobalVariable - identifier - (TRANSIENT)">cout</span>&nbsp;<span class="cppOperator - operator - (TRANSIENT)">&lt;&lt;</span>&nbsp;<span class="string">&quot;Name&nbsp;=&nbsp;&quot;</span>&nbsp;<span class="cppOperator - operator - (TRANSIENT)">&lt;&lt;</span>&nbsp;<span class="cppLocalVariable - identifier - (TRANSIENT)">p2</span><span class="operator">.</span><span class="cppMemberField - identifier - (TRANSIENT)">name</span>&nbsp;<span class="cppOperator - operator - (TRANSIENT)">&lt;&lt;</span>&nbsp;<span class="string">&quot;,&nbsp;age&nbsp;=&nbsp;&quot;</span>&nbsp;<span class="cppMemberOperator - operator - (TRANSIENT)">&lt;&lt;</span>&nbsp;<span class="cppLocalVariable - identifier - (TRANSIENT)">p2</span><span class="operator">.</span><span class="cppMemberField - identifier - (TRANSIENT)">age</span>&nbsp;<span class="cppOperator - operator - (TRANSIENT)">&lt;&lt;</span>&nbsp;<span class="string">&quot;\n&quot;</span><span class="operator">;</span></pre>

<p>Output:</p>

<pre class="console-output">{
    "age": 30,
    "name": "John"
}
Name = John, age = 30</pre>

<p>Simple as that!</p>

<!--more-->
<p><a class="anchor" id="read-more"></a></p>

<p>One more example. In <a href="https://eliasdaler.github.io/re-creation/">my game</a> I have <code class="highlighter-rouge">Animation</code> class registered. I also have a bunch of functions for <a href="https://github.com/ocornut/imgui">ImGui</a> which can automatically build GUI for me, so I can easily change animation parameters. I just do this:</p>

<pre class="vs-code"><span class="cppNamespace - identifier - (TRANSIENT)">ImGui</span><span class="operator">::</span><span class="cppFunction - identifier - (TRANSIENT)">Input</span><span class="operator">(</span><span class="cppLocalVariable - identifier - (TRANSIENT)">animation</span><span class="operator">);</span>
</pre>

<p>And I get this (the “Animation properties” table is generated by MetaStuff):</p>

<p class="img-desc"><img src="https://i.imgur.com/A44zLlb.gif" alt="Animation editor" />
Animation editor</p>

<h2 id="using-metastuff">Using MetaStuff</h2>

<p>The most important thing about MetaStuff is that it stores information about class members in a tuple without losing their types. To do something for all members of the class, you write this:</p>

<pre class="vs-code"><span class="cppNamespace - identifier - (TRANSIENT)">meta</span><span class="operator">::</span><span class="cppFunction - identifier - (TRANSIENT)">doForAllMembers</span><span class="operator">&lt;</span><span class="cppType - identifier - (TRANSIENT)">Person</span><span class="operator">&gt;(</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">[&amp;</span><span class="cppLocalVariable - identifier - (TRANSIENT)">person</span><span class="operator">](</span><span class="keyword">const</span>&nbsp;<span class="keyword">auto</span><span class="operator">&amp;</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">member</span><span class="operator">)</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;do&nbsp;something&nbsp;for&nbsp;member</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">});</span></pre>

<p>The type of <code class="highlighter-rouge">member</code> inside the lambda is <code class="highlighter-rouge">meta::Member&lt;Person, T&gt;</code>, where <code class="highlighter-rouge">T</code> is a type of a member you previously registered. This is really nice, because just by calling <code class="highlighter-rouge">Member&lt;Person, T&gt;::get(person)</code>, you get a reference to an object from <code class="highlighter-rouge">person</code> instance, which you can modify and use in other functions.</p>

<p>Let’s look at a simple example.</p>

<pre class="vs-code"><span class="cppType - identifier - (TRANSIENT)">Person</span>&nbsp;<span class="cppLocalVariable - identifier - (TRANSIENT)">person</span><span class="operator">;</span>
<span class="cppLocalVariable - identifier - (TRANSIENT)">person</span><span class="operator">.</span><span class="cppMemberField - identifier - (TRANSIENT)">age</span>&nbsp;<span class="operator">=</span>&nbsp;<span class="number">30</span><span class="operator">;</span>
<span class="cppLocalVariable - identifier - (TRANSIENT)">person</span><span class="operator">.</span><span class="cppMemberField - identifier - (TRANSIENT)">name</span>&nbsp;<span class="cppMemberOperator - operator - (TRANSIENT)">=</span>&nbsp;<span class="string">&quot;John&quot;</span><span class="operator">;</span>

<span class="cppNamespace - identifier - (TRANSIENT)">meta</span><span class="operator">::</span><span class="cppFunction - identifier - (TRANSIENT)">doForAllMembers</span><span class="operator">&lt;</span><span class="cppType - identifier - (TRANSIENT)">Person</span><span class="operator">&gt;(</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">[&amp;</span><span class="cppLocalVariable - identifier - (TRANSIENT)">person</span><span class="operator">](</span><span class="keyword">const</span>&nbsp;<span class="keyword">auto</span><span class="operator">&amp;</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">member</span><span class="operator">)</span>
<span class="operator">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">using</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">MemberT</span>&nbsp;<span class="operator">=</span>&nbsp;<span class="cppNamespace - identifier - (TRANSIENT)">meta</span><span class="operator">::</span><span class="cppType - identifier - (TRANSIENT)">get_member_type</span><span class="operator">&lt;</span><span class="keyword">decltype</span><span class="operator">(</span><span class="cppParameter - identifier - (TRANSIENT)">member</span><span class="operator">)&gt;;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppNamespace - identifier - (TRANSIENT)">std</span><span class="operator">::</span><span class="cppGlobalVariable - identifier - (TRANSIENT)">cout</span>&nbsp;<span class="cppOperator - operator - (TRANSIENT)">&lt;&lt;</span>&nbsp;<span class="string">&quot;*&nbsp;&quot;</span>&nbsp;<span class="operator">&lt;&lt;</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">member</span><span class="operator">.</span><span class="identifier">getName</span><span class="operator">()</span>&nbsp;<span class="operator">&lt;&lt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">&quot;,&nbsp;value&nbsp;=&nbsp;&quot;</span>&nbsp;<span class="operator">&lt;&lt;</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">member</span><span class="operator">.</span><span class="identifier">get</span><span class="operator">(</span><span class="cppLocalVariable - identifier - (TRANSIENT)">person</span><span class="operator">)</span>&nbsp;<span class="operator">&lt;&lt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">&quot;,&nbsp;type&nbsp;=&nbsp;&quot;</span>&nbsp;<span class="operator">&lt;&lt;</span>&nbsp;<span class="keyword">typeid</span><span class="operator">(</span><span class="cppType - identifier - (TRANSIENT)">MemberT</span><span class="operator">).</span><span class="cppMemberFunction - identifier - (TRANSIENT)">name</span><span class="operator">()</span>&nbsp;<span class="operator">&lt;&lt;</span>&nbsp;<span class="string">&#39;\n&#39;</span><span class="operator">;</span>
<span class="operator">});</span></pre>

<p>Output:</p>

<pre class="console-output">* age, value = 30, type = int
* name, value = John, type = class std::basic_string&lt;char,struct std::char_traits&lt;char&gt;,class std::allocator&lt;char&gt; &gt;</pre>

<hr />

<p>You can iterate over all members and call template functions or functions with overloads. Suppose you have a function:</p>

<pre class="vs-code"><span class="keyword">template</span>&nbsp;<span class="operator">&lt;</span><span class="keyword">typename</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">T</span><span class="operator">&gt;</span>
<span class="keyword">void</span>&nbsp;<span class="cppFunctionTemplate - identifier - (TRANSIENT)">print</span><span class="operator">(</span><span class="cppType - identifier - (TRANSIENT)">T</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">obj</span><span class="operator">)</span>&nbsp;<span class="operator">{};</span>

<span class="keyword">void</span>&nbsp;<span class="cppFunction - identifier - (TRANSIENT)">print</span><span class="operator">(</span><span class="keyword">int</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">i</span><span class="operator">)</span>
<span class="operator">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppNamespace - identifier - (TRANSIENT)">std</span><span class="operator">::</span><span class="cppGlobalVariable - identifier - (TRANSIENT)">cout</span>&nbsp;<span class="cppOperator - operator - (TRANSIENT)">&lt;&lt;</span>&nbsp;<span class="string">&quot;It&#39;s&nbsp;an&nbsp;int!&nbsp;Value&nbsp;=&nbsp;&quot;</span>&nbsp;<span class="cppMemberOperator - operator - (TRANSIENT)">&lt;&lt;</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">i</span><span class="operator">;</span>
<span class="operator">}</span>

<span class="keyword">void</span>&nbsp;<span class="cppFunction - identifier - (TRANSIENT)">print</span><span class="operator">(</span><span class="keyword">const</span>&nbsp;<span class="cppNamespace - identifier - (TRANSIENT)">std</span><span class="operator">::</span><span class="cppType - identifier - (TRANSIENT)">string</span><span class="operator">&amp;</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">str</span><span class="operator">)</span>
<span class="operator">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppNamespace - identifier - (TRANSIENT)">std</span><span class="operator">::</span><span class="cppGlobalVariable - identifier - (TRANSIENT)">cout</span>&nbsp;<span class="cppOperator - operator - (TRANSIENT)">&lt;&lt;</span>&nbsp;<span class="string">&quot;It&#39;s&nbsp;a&nbsp;string!&nbsp;Value&nbsp;=&nbsp;&quot;</span>&nbsp;<span class="cppOperator - operator - (TRANSIENT)">&lt;&lt;</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">str</span><span class="operator">;</span>
<span class="operator">}</span></pre>

<p>And now we do this:</p>

<pre class="vs-code"><span class="cppNamespace - identifier - (TRANSIENT)">meta</span><span class="operator">::</span><span class="cppFunction - identifier - (TRANSIENT)">doForAllMembers</span><span class="operator">&lt;</span><span class="cppType - identifier - (TRANSIENT)">Person</span><span class="operator">&gt;(</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">[&amp;</span><span class="cppLocalVariable - identifier - (TRANSIENT)">person</span><span class="operator">](</span><span class="keyword">const</span>&nbsp;<span class="keyword">auto</span><span class="operator">&amp;</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">member</span><span class="operator">)</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppNamespace - identifier - (TRANSIENT)">std</span><span class="operator">::</span><span class="cppGlobalVariable - identifier - (TRANSIENT)">cout</span>&nbsp;<span class="cppOperator - operator - (TRANSIENT)">&lt;&lt;</span>&nbsp;<span class="string">&quot;*&nbsp;&quot;</span>&nbsp;<span class="cppOperator - operator - (TRANSIENT)">&lt;&lt;</span>&nbsp;<span class="string">&quot;What&nbsp;is&nbsp;&quot;</span>&nbsp;<span class="operator">&lt;&lt;</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">member</span><span class="operator">.</span><span class="identifier">getName</span><span class="operator">()</span>&nbsp;<span class="operator">&lt;&lt;</span>&nbsp;<span class="string">&quot;&nbsp;?&nbsp;&quot;</span><span class="operator">;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="identifier">print</span><span class="operator">(</span><span class="cppParameter - identifier - (TRANSIENT)">member</span><span class="operator">.</span><span class="identifier">get</span><span class="operator">(</span><span class="cppLocalVariable - identifier - (TRANSIENT)">person</span><span class="operator">));</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppNamespace - identifier - (TRANSIENT)">std</span><span class="operator">::</span><span class="cppGlobalVariable - identifier - (TRANSIENT)">cout</span>&nbsp;<span class="cppOperator - operator - (TRANSIENT)">&lt;&lt;</span>&nbsp;<span class="string">&#39;\n&#39;</span><span class="operator">;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">});</span></pre>

<p>Output:</p>
<pre class="console-output">* What is age ? It's an int! Value = 30
* What is name ? It's a string! Value = John
</pre>

<p><a href="https://github.com/eliasdaler/MetaStuff/blob/master/example/JsonCast.inl#L86">Here</a> you can look at how JSON serialization / deserialization is performed. It’s not that complicated: we just need to write some overloads for non-trivial cases (<code class="highlighter-rouge">std::vector</code> should be processed as JSON array and <code class="highlighter-rouge">std::unordered_map</code> as JSON object). For the main serialization / deserialization loop, we just need to iterate over all registered members and do something like this:</p>

<pre class="vs-code"><span class="cppLocalVariable - identifier - (TRANSIENT)">jsonObject</span><span class="operator">[</span><span class="cppParameter - identifier - (TRANSIENT)">member</span><span class="operator">.</span><span class="identifier">getName</span><span class="operator">()]</span>&nbsp;<span class="operator">=</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">member</span><span class="operator">.</span><span class="identifier">get</span><span class="operator">(</span><span class="cppLocalVariable - identifier - (TRANSIENT)">person</span><span class="operator">);</span>
</pre>

<p>The serializer can handle much more complex cases, than shown previously, such as instance of one class, being in another class: the serialization will work correctly for registered classes! For example, for the following classes:</p>

<pre class="vs-code"><span class="keyword">struct</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">Health</span>&nbsp;<span class="operator">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span>&nbsp;<span class="cppMemberField - identifier - (TRANSIENT)">hp</span>&nbsp;<span class="operator">=</span>&nbsp;<span class="number">20</span><span class="operator">;</span>
<span class="operator">};</span>

<span class="keyword">struct</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">Hero</span>&nbsp;<span class="operator">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppType - identifier - (TRANSIENT)">Health</span>&nbsp;<span class="cppMemberField - identifier - (TRANSIENT)">health</span><span class="operator">;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span>&nbsp;<span class="cppMemberField - identifier - (TRANSIENT)">attackPower</span>&nbsp;<span class="operator">=</span>&nbsp;<span class="number">30</span><span class="operator">;</span>
<span class="operator">};</span></pre>

<p>we’ll get this JSON:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"attackPower"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w">
    </span><span class="nl">"health"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"hp"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="nice-things-about-metastuff">Nice things about MetaStuff</h2>

<ul>
  <li>It doesn’t require you to perform some pre-build process to generate additional code.</li>
  <li>It doesn’t use RTTI.</li>
  <li>You don’t need to modify your class to register meta info about it. This allows you to register classes from code you can’t modify, such as libraries.</li>
  <li>It’s not constrained to one format or library: you can implement your own serializer / deserializer to any format you want.</li>
  <li>Surprisingly, the code works pretty fast and compilers optimize a lot behind the scenes. My game loads animations using MetaStuff and the performance is pretty close to JSON deserialization written by hand.</li>
  <li>This library can be used for other things other than serialization, such as building GUIs.</li>
  <li>You can use it with getters and setters, instead of raw member pointers.</li>
</ul>

<p>Suppose our <code class="highlighter-rouge">Person</code> class now looks like this:</p>
<pre class="vs-code"><span class="keyword">class</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">Person</span>&nbsp;<span class="operator">{</span>
<span class="keyword">public</span><span class="operator">:</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">void</span>&nbsp;<span class="cppMemberFunction - identifier - (TRANSIENT)">setAge</span><span class="operator">(</span><span class="keyword">int</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">a</span><span class="operator">)</span>&nbsp;<span class="operator">{</span>&nbsp;<span class="cppMemberField - identifier - (TRANSIENT)">age</span>&nbsp;<span class="operator">=</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">a</span><span class="operator">;</span>&nbsp;<span class="operator">}</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span>&nbsp;<span class="cppMemberFunction - identifier - (TRANSIENT)">getAge</span><span class="operator">()</span>&nbsp;<span class="keyword">const</span>&nbsp;<span class="operator">{</span>&nbsp;<span class="keyword">return</span>&nbsp;<span class="cppMemberField - identifier - (TRANSIENT)">age</span><span class="operator">;</span>&nbsp;<span class="operator">}</span>

&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;...&nbsp;same&nbsp;for&nbsp;name</span>
<span class="keyword">private</span><span class="operator">:</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span>&nbsp;<span class="cppMemberField - identifier - (TRANSIENT)">age</span><span class="operator">;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppNamespace - identifier - (TRANSIENT)">std</span><span class="operator">::</span><span class="cppType - identifier - (TRANSIENT)">string</span>&nbsp;<span class="cppMemberField - identifier - (TRANSIENT)">name</span><span class="operator">;</span>
<span class="operator">};</span></pre>

<p>We pass getter and setter to MetaStuff during registration:</p>
<pre class="vs-code"><span class="identifier">member</span><span class="operator">(</span><span class="string">&quot;age&quot;</span><span class="operator">,</span>&nbsp;<span class="operator">&amp;</span><span class="cppType - identifier - (TRANSIENT)">Person</span><span class="operator">::</span><span class="identifier">getAge</span><span class="operator">,</span>&nbsp;<span class="operator">&amp;</span><span class="cppType - identifier - (TRANSIENT)">Person</span><span class="operator">::</span><span class="cppMemberFunction - identifier - (TRANSIENT)">setAge</span><span class="operator">)</span>
</pre>

<p>Now, when we’ll serialize object, <code class="highlighter-rouge">Person::getAge</code> will get called when getting value of “age” member.</p>

<hr />

<p>You can make more complex serialization process easier by using getters and setters in a non-standard way.
Suppose that you have <code class="highlighter-rouge">Sprite</code> class:</p>

<pre class="vs-code"><span class="keyword">class</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">Sprite</span>&nbsp;<span class="operator">{</span>
<span class="keyword">public</span><span class="operator">:</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;...</span>
<span class="keyword">private</span><span class="operator">:</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppType - identifier - (TRANSIENT)">Texture</span>&nbsp;<span class="cppMemberField - identifier - (TRANSIENT)">texture</span><span class="operator">;</span>
<span class="operator">};</span></pre>

<p>How do you deserialize it? It’s not possible to store <code class="highlighter-rouge">Texture</code> in a JSON, so we’ll store a texture filename instead:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"texture"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"res/images/hero.png"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>But how do we load texture when reading data from JSON? One solution is to register variable, which will store texture’s filename, and later call some <code class="highlighter-rouge">postInit</code> function:</p>

<pre class="vs-code"><span class="cppNamespace - identifier - (TRANSIENT)">meta</span><span class="operator">::</span><span class="cppFunction - identifier - (TRANSIENT)">member</span><span class="operator">(</span><span class="string">&quot;texture&quot;</span><span class="operator">,</span>&nbsp;<span class="operator">&amp;</span><span class="cppType - identifier - (TRANSIENT)">Sprite</span><span class="operator">::</span><span class="cppMemberField - identifier - (TRANSIENT)">textureFilename</span><span class="operator">);</span>
</pre>

<pre class="vs-code"><span class="keyword">void</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">Sprite</span><span class="operator">::</span><span class="cppMemberFunction - identifier - (TRANSIENT)">postInit</span><span class="operator">()</span>
<span class="operator">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppMemberField - identifier - (TRANSIENT)">texture</span><span class="operator">.</span><span class="cppMemberFunction - identifier - (TRANSIENT)">loadFromFile</span><span class="operator">(</span><span class="cppMemberField - identifier - (TRANSIENT)">textureFilename</span><span class="operator">);</span>
<span class="operator">}</span></pre>

<pre class="vs-code"><span class="cppType - identifier - (TRANSIENT)">Sprite</span>&nbsp;<span class="cppLocalVariable - identifier - (TRANSIENT)">s</span><span class="operator">;</span>
<span class="cppLocalVariable - identifier - (TRANSIENT)">s</span>&nbsp;<span class="cppMemberOperator - operator - (TRANSIENT)">=</span>&nbsp;<span class="cppLocalVariable - identifier - (TRANSIENT)">j</span><span class="operator">.</span><span class="cppMemberFunction - identifier - (TRANSIENT)">get</span><span class="operator">&lt;</span><span class="cppType - identifier - (TRANSIENT)">Sprite</span><span class="operator">&gt;();</span>&nbsp;<span class="comment">//&nbsp;here&nbsp;we&#39;ll&nbsp;get&nbsp;textureFilename</span>
<span class="cppLocalVariable - identifier - (TRANSIENT)">s</span><span class="operator">.</span><span class="cppMemberFunction - identifier - (TRANSIENT)">postInit</span><span class="operator">();</span>&nbsp;<span class="comment">//&nbsp;and&nbsp;here&nbsp;our&nbsp;texture&nbsp;we&#39;ll&nbsp;be&nbsp;loaded</span></pre>

<p>This works, but we can do better! Let’s register a <code class="highlighter-rouge">loadTexture</code> function as a setter for “texture”.</p>

<pre class="vs-code"><span class="cppNamespace - identifier - (TRANSIENT)">meta</span><span class="operator">::</span><span class="cppFunction - identifier - (TRANSIENT)">member</span><span class="operator">(</span><span class="string">&quot;texture&quot;</span><span class="operator">,</span>&nbsp;<span class="operator">&amp;</span><span class="cppType - identifier - (TRANSIENT)">Sprite</span><span class="operator">::</span><span class="cppMemberFunction - identifier - (TRANSIENT)">getTextureFilename</span><span class="operator">,</span>&nbsp;<span class="operator">&amp;</span><span class="cppType - identifier - (TRANSIENT)">Sprite</span><span class="operator">::</span><span class="cppMemberFunction - identifier - (TRANSIENT)">loadTexture</span><span class="operator">);</span>
</pre>

<pre class="vs-code"><span class="keyword">const</span>&nbsp;<span class="cppNamespace - identifier - (TRANSIENT)">std</span><span class="operator">::</span><span class="cppType - identifier - (TRANSIENT)">string</span><span class="operator">&amp;</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">Sprite</span><span class="operator">::</span><span class="cppMemberFunction - identifier - (TRANSIENT)">getTextureFilename</span><span class="operator">()</span>&nbsp;<span class="keyword">const</span>
<span class="operator">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span>&nbsp;<span class="cppMemberField - identifier - (TRANSIENT)">textureFilename</span><span class="operator">;</span>
<span class="operator">}</span>

<span class="keyword">void</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">Sprite</span><span class="operator">::</span><span class="cppMemberFunction - identifier - (TRANSIENT)">loadTexture</span><span class="operator">(</span><span class="keyword">const</span>&nbsp;<span class="cppNamespace - identifier - (TRANSIENT)">std</span><span class="operator">::</span><span class="cppType - identifier - (TRANSIENT)">string</span><span class="operator">&amp;</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">filename</span><span class="operator">)</span>
<span class="operator">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppMemberField - identifier - (TRANSIENT)">textureFilename</span>&nbsp;<span class="cppMemberOperator - operator - (TRANSIENT)">=</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">filename</span><span class="operator">;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppMemberField - identifier - (TRANSIENT)">texture</span><span class="operator">.</span><span class="cppMemberFunction - identifier - (TRANSIENT)">loadFromFile</span><span class="operator">(</span><span class="cppParameter - identifier - (TRANSIENT)">filename</span><span class="operator">);</span>
<span class="operator">}</span></pre>

<p>Now, when you’ll deserialize from JSON, <code class="highlighter-rouge">loadTexture</code> will be called and the texture will get loaded as you want it to. And when you serialize <code class="highlighter-rouge">Sprite</code> class to JSON, texture filename gets saved there.</p>

<p>Now, let’s implement simple meta info holder and see how I came from its design to MetaStuff.</p>

<h2 id="simple-approach-that-kinda-works">Simple approach (that kinda works)</h2>

<p>It all started from a simple, yet somewhat flawed approach. One easy way to build a meta system is to make it with type-erasure and virtual functions. Full working example can be found <a href="https://gist.github.com/eliasdaler/213d42051958ae21185adbc7edbff915">here</a>.</p>

<pre class="vs-code"><span class="keyword">template</span>&nbsp;<span class="operator">&lt;</span><span class="keyword">typename</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">Class</span><span class="operator">&gt;</span>
<span class="keyword">class</span>&nbsp;<span class="cppClassTemplate - identifier - (TRANSIENT)">IMember</span>&nbsp;<span class="operator">{</span>
<span class="keyword">public</span><span class="operator">:</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">virtual</span>&nbsp;<span class="cppMemberFunction - operator - (TRANSIENT)">~</span><span class="cppMemberFunction - identifier - (TRANSIENT)">IMember</span><span class="operator">()</span>&nbsp;<span class="operator">=</span>&nbsp;<span class="keyword">default</span><span class="operator">;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">virtual</span>&nbsp;<span class="keyword">void</span>&nbsp;<span class="cppMemberFunction - identifier - (TRANSIENT)">fromJson</span><span class="operator">(</span><span class="cppType - identifier - (TRANSIENT)">Class</span><span class="operator">&amp;</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">obj</span><span class="operator">,</span>&nbsp;<span class="keyword">const</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">json</span><span class="operator">&amp;</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">j</span><span class="operator">)</span>&nbsp;<span class="keyword">const</span>&nbsp;<span class="operator">=</span>&nbsp;<span class="number">0</span><span class="operator">;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">virtual</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">json</span>&nbsp;<span class="cppMemberFunction - identifier - (TRANSIENT)">toJson</span><span class="operator">(</span><span class="keyword">const</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">Class</span><span class="operator">&amp;</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">obj</span><span class="operator">)</span>&nbsp;<span class="keyword">const</span>&nbsp;<span class="operator">=</span>&nbsp;<span class="number">0</span><span class="operator">;</span>
<span class="operator">};</span></pre>
<p><code class="highlighter-rouge">IMember</code> is a base class for <code class="highlighter-rouge">Member</code> class which will store member info.</p>

<pre class="vs-code"><span class="keyword">template</span>&nbsp;<span class="operator">&lt;</span><span class="keyword">typename</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">Class</span><span class="operator">,</span>&nbsp;<span class="keyword">typename</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">T</span><span class="operator">&gt;</span>
<span class="keyword">class</span>&nbsp;<span class="cppClassTemplate - identifier - (TRANSIENT)">Member</span>&nbsp;<span class="operator">:</span>&nbsp;<span class="keyword">public</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">IMember</span><span class="operator">&lt;</span><span class="cppType - identifier - (TRANSIENT)">Class</span><span class="operator">&gt;</span>&nbsp;<span class="operator">{</span>
<span class="keyword">public</span><span class="operator">:</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppMemberFunction - identifier - (TRANSIENT)">Member</span><span class="operator">(</span><span class="cppType - identifier - (TRANSIENT)">T</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">Class</span><span class="operator">::*</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">ptr</span><span class="operator">)</span>&nbsp;<span class="operator">:</span>&nbsp;<span class="cppMemberField - identifier - (TRANSIENT)">ptr</span><span class="operator">(</span><span class="cppParameter - identifier - (TRANSIENT)">ptr</span><span class="operator">)</span>&nbsp;<span class="operator">{}</span>

&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">void</span>&nbsp;<span class="cppMemberFunction - identifier - (TRANSIENT)">fromJson</span><span class="operator">(</span><span class="cppType - identifier - (TRANSIENT)">Class</span><span class="operator">&amp;</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">obj</span><span class="operator">,</span>&nbsp;<span class="keyword">const</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">json</span><span class="operator">&amp;</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">j</span><span class="operator">)</span>&nbsp;<span class="keyword">const</span>&nbsp;<span class="keyword">override</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">obj</span><span class="operator">.*</span><span class="cppMemberField - identifier - (TRANSIENT)">ptr</span>&nbsp;<span class="operator">=</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">j</span><span class="operator">;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">}</span>

&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppType - identifier - (TRANSIENT)">json</span>&nbsp;<span class="cppMemberFunction - identifier - (TRANSIENT)">toJson</span><span class="operator">(</span><span class="keyword">const</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">Class</span><span class="operator">&amp;</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">obj</span><span class="operator">)</span>&nbsp;<span class="keyword">const</span>&nbsp;<span class="keyword">override</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">json</span><span class="operator">(</span><span class="cppParameter - identifier - (TRANSIENT)">obj</span><span class="operator">.*</span><span class="cppMemberField - identifier - (TRANSIENT)">ptr</span><span class="operator">);</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">}</span>

<span class="keyword">private</span><span class="operator">:</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppType - identifier - (TRANSIENT)">T</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">Class</span><span class="operator">::*</span>&nbsp;<span class="cppMemberField - identifier - (TRANSIENT)">ptr</span><span class="operator">;</span>
<span class="operator">};</span></pre>
<p><code class="highlighter-rouge">Member</code> class stores a pointer to a class member which lets us get it directly from <code class="highlighter-rouge">Class</code> instance (see how we need to pass it in <code class="highlighter-rouge">fromJson</code> / <code class="highlighter-rouge">toJson</code> function).</p>

<p>And now for the class that will store all info about members of a particular class:</p>

<pre class="vs-code"><span class="keyword">template</span>&nbsp;<span class="operator">&lt;</span><span class="keyword">typename</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">Class</span><span class="operator">&gt;</span>
<span class="keyword">class</span>&nbsp;<span class="cppClassTemplate - identifier - (TRANSIENT)">ClassMetaInfo</span>&nbsp;<span class="operator">{</span>
<span class="keyword">public</span><span class="operator">:</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">static</span>&nbsp;<span class="keyword">void</span>&nbsp;<span class="cppStaticMemberFunction - identifier - (TRANSIENT)">serialize</span><span class="operator">(</span><span class="cppType - identifier - (TRANSIENT)">Class</span><span class="operator">&amp;</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">obj</span><span class="operator">,</span>&nbsp;<span class="keyword">const</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">json</span><span class="operator">&amp;</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">j</span><span class="operator">)</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;<span class="operator">(</span><span class="keyword">const</span>&nbsp;<span class="keyword">auto</span><span class="operator">&amp;</span>&nbsp;<span class="cppLocalVariable - identifier - (TRANSIENT)">pair</span>&nbsp;<span class="operator">:</span>&nbsp;<span class="cppStaticMemberField - identifier - (TRANSIENT)">members</span><span class="operator">)</span>&nbsp;<span class="operator">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">const</span>&nbsp;<span class="keyword">auto</span><span class="operator">&amp;</span>&nbsp;<span class="cppLocalVariable - identifier - (TRANSIENT)">memberName</span>&nbsp;<span class="operator">=</span>&nbsp;<span class="cppLocalVariable - identifier - (TRANSIENT)">pair</span><span class="operator">.</span><span class="identifier">first</span><span class="operator">;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">const</span>&nbsp;<span class="keyword">auto</span><span class="operator">&amp;</span>&nbsp;<span class="cppLocalVariable - identifier - (TRANSIENT)">memberPtr</span>&nbsp;<span class="operator">=</span>&nbsp;<span class="cppLocalVariable - identifier - (TRANSIENT)">pair</span><span class="operator">.</span><span class="identifier">second</span><span class="operator">;</span>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppLocalVariable - identifier - (TRANSIENT)">memberPtr</span><span class="operator">-&gt;</span><span class="identifier">fromJson</span><span class="operator">(</span><span class="cppParameter - identifier - (TRANSIENT)">obj</span><span class="operator">,</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">j</span><span class="operator">[</span><span class="cppLocalVariable - identifier - (TRANSIENT)">memberName</span><span class="operator">]);</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">}</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">}</span>

&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">static</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">json</span>&nbsp;<span class="cppStaticMemberFunction - identifier - (TRANSIENT)">deserialize</span><span class="operator">(</span><span class="keyword">const</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">Class</span><span class="operator">&amp;</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">obj</span><span class="operator">)</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppType - identifier - (TRANSIENT)">json</span>&nbsp;<span class="cppLocalVariable - identifier - (TRANSIENT)">j</span><span class="operator">;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;<span class="operator">(</span><span class="keyword">const</span>&nbsp;<span class="keyword">auto</span><span class="operator">&amp;</span>&nbsp;<span class="cppLocalVariable - identifier - (TRANSIENT)">pair</span>&nbsp;<span class="operator">:</span>&nbsp;<span class="cppStaticMemberField - identifier - (TRANSIENT)">members</span><span class="operator">)</span>&nbsp;<span class="operator">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">const</span>&nbsp;<span class="keyword">auto</span><span class="operator">&amp;</span>&nbsp;<span class="cppLocalVariable - identifier - (TRANSIENT)">memberName</span>&nbsp;<span class="operator">=</span>&nbsp;<span class="cppLocalVariable - identifier - (TRANSIENT)">pair</span><span class="operator">.</span><span class="identifier">first</span><span class="operator">;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">const</span>&nbsp;<span class="keyword">auto</span><span class="operator">&amp;</span>&nbsp;<span class="cppLocalVariable - identifier - (TRANSIENT)">memberPtr</span>&nbsp;<span class="operator">=</span>&nbsp;<span class="cppLocalVariable - identifier - (TRANSIENT)">pair</span><span class="operator">.</span><span class="identifier">second</span><span class="operator">;</span>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppLocalVariable - identifier - (TRANSIENT)">j</span><span class="operator">[</span><span class="cppLocalVariable - identifier - (TRANSIENT)">memberName</span><span class="operator">]</span>&nbsp;<span class="operator">=</span>&nbsp;<span class="cppLocalVariable - identifier - (TRANSIENT)">memberPtr</span><span class="operator">-&gt;</span><span class="identifier">toJson</span><span class="operator">(</span><span class="cppParameter - identifier - (TRANSIENT)">obj</span><span class="operator">);</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">}</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span>&nbsp;<span class="cppLocalVariable - identifier - (TRANSIENT)">j</span><span class="operator">;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">}</span>

&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">template</span>&nbsp;<span class="operator">&lt;</span><span class="keyword">typename</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">T</span><span class="operator">&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">static</span>&nbsp;<span class="keyword">void</span>&nbsp;<span class="cppStaticMemberFunction - identifier - (TRANSIENT)">registerMember</span><span class="operator">(</span><span class="keyword">const</span>&nbsp;<span class="keyword">char</span><span class="operator">*</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">name</span><span class="operator">,</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">T</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">Class</span><span class="operator">::*</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">ptr</span><span class="operator">)</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppStaticMemberField - identifier - (TRANSIENT)">members</span><span class="operator">.</span><span class="identifier">emplace</span><span class="operator">(</span><span class="cppParameter - identifier - (TRANSIENT)">name</span><span class="operator">,</span>&nbsp;<span class="cppNamespace - identifier - (TRANSIENT)">std</span><span class="operator">::</span><span class="identifier">make_unique</span><span class="operator">&lt;</span><span class="cppType - identifier - (TRANSIENT)">Member</span><span class="operator">&lt;</span><span class="cppType - identifier - (TRANSIENT)">Class</span><span class="operator">,</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">T</span><span class="operator">&gt;&gt;(</span><span class="cppParameter - identifier - (TRANSIENT)">ptr</span><span class="operator">));</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">}</span>

&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">using</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">MemberPtrType</span>&nbsp;<span class="operator">=</span>&nbsp;<span class="cppNamespace - identifier - (TRANSIENT)">std</span><span class="operator">::</span><span class="cppType - identifier - (TRANSIENT)">unique_ptr</span><span class="operator">&lt;</span><span class="cppType - identifier - (TRANSIENT)">IMember</span><span class="operator">&lt;</span><span class="cppType - identifier - (TRANSIENT)">Class</span><span class="operator">&gt;&gt;;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">using</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">MemberMapType</span>&nbsp;<span class="operator">=</span>&nbsp;<span class="cppNamespace - identifier - (TRANSIENT)">std</span><span class="operator">::</span><span class="cppType - identifier - (TRANSIENT)">unordered_map</span><span class="operator">&lt;</span><span class="cppNamespace - identifier - (TRANSIENT)">std</span><span class="operator">::</span><span class="cppType - identifier - (TRANSIENT)">string</span><span class="operator">,</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">MemberPtrType</span><span class="operator">&gt;;</span>
<span class="keyword">private</span><span class="operator">:</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">static</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">MemberMapType</span>&nbsp;<span class="cppStaticMemberField - identifier - (TRANSIENT)">members</span><span class="operator">;</span>
<span class="operator">};</span>

<span class="keyword">template</span>&nbsp;<span class="operator">&lt;</span><span class="keyword">typename</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">Class</span><span class="operator">&gt;</span>
<span class="keyword">typename</span>&nbsp;<span class="cppClassTemplate - identifier - (TRANSIENT)">ClassMetaInfo</span><span class="operator">&lt;</span><span class="cppType - identifier - (TRANSIENT)">Class</span><span class="operator">&gt;::</span><span class="cppType - identifier - (TRANSIENT)">MemberMapType</span>&nbsp;<span class="cppClassTemplate - identifier - (TRANSIENT)">ClassMetaInfo</span><span class="operator">&lt;</span><span class="cppType - identifier - (TRANSIENT)">Class</span><span class="operator">&gt;::</span><span class="cppStaticMemberField - identifier - (TRANSIENT)">members</span><span class="operator">;</span></pre>

<p><code class="highlighter-rouge">ClassMetaInfo</code> class stores all members in members <code class="highlighter-rouge">unordered_map</code>. We can’t store objects of different classes inside <code class="highlighter-rouge">unordered_map</code>, because <code class="highlighter-rouge">Member&lt;Class, int&gt;</code> and <code class="highlighter-rouge">Member&lt;Class, std::string&gt;</code> have different types. That’s why they have the common base class and virtual functions which will help us get the original type back (at least for a function call).</p>

<p>Let’s use it:</p>

<pre class="vs-code"><span class="keyword">struct</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">Person</span>&nbsp;<span class="operator">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppNamespace - identifier - (TRANSIENT)">std</span><span class="operator">::</span><span class="cppType - identifier - (TRANSIENT)">string</span>&nbsp;<span class="cppMemberField - identifier - (TRANSIENT)">name</span><span class="operator">;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span>&nbsp;<span class="cppMemberField - identifier - (TRANSIENT)">age</span><span class="operator">;</span>

&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">static</span>&nbsp;<span class="keyword">void</span>&nbsp;<span class="cppStaticMemberFunction - identifier - (TRANSIENT)">registerClass</span><span class="operator">()</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppType - identifier - (TRANSIENT)">ClassMetaInfo</span><span class="operator">&lt;</span><span class="cppType - identifier - (TRANSIENT)">Person</span><span class="operator">&gt;::</span><span class="cppStaticMemberFunction - identifier - (TRANSIENT)">registerMember</span><span class="operator">(</span><span class="string">&quot;name&quot;</span><span class="operator">,</span>&nbsp;<span class="operator">&amp;</span><span class="cppType - identifier - (TRANSIENT)">Person</span><span class="operator">::</span><span class="cppMemberField - identifier - (TRANSIENT)">name</span><span class="operator">);</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppType - identifier - (TRANSIENT)">ClassMetaInfo</span><span class="operator">&lt;</span><span class="cppType - identifier - (TRANSIENT)">Person</span><span class="operator">&gt;::</span><span class="cppStaticMemberFunction - identifier - (TRANSIENT)">registerMember</span><span class="operator">(</span><span class="string">&quot;age&quot;</span><span class="operator">,</span>&nbsp;<span class="operator">&amp;</span><span class="cppType - identifier - (TRANSIENT)">Person</span><span class="operator">::</span><span class="cppMemberField - identifier - (TRANSIENT)">age</span><span class="operator">);</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">}</span>
<span class="operator">};</span>

<span class="keyword">int</span>&nbsp;<span class="cppFunction - identifier - (TRANSIENT)">main</span><span class="operator">()</span>
<span class="operator">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppType - identifier - (TRANSIENT)">Person</span><span class="operator">::</span><span class="cppStaticMemberFunction - identifier - (TRANSIENT)">registerClass</span><span class="operator">();</span>

&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppType - identifier - (TRANSIENT)">Person</span>&nbsp;<span class="cppLocalVariable - identifier - (TRANSIENT)">p</span><span class="operator">{</span>&nbsp;<span class="string">&quot;John&quot;</span><span class="operator">,</span>&nbsp;<span class="number">30</span>&nbsp;<span class="operator">};</span>

&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppType - identifier - (TRANSIENT)">json</span>&nbsp;<span class="cppLocalVariable - identifier - (TRANSIENT)">j</span>&nbsp;<span class="operator">=</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">ClassMetaInfo</span><span class="operator">&lt;</span><span class="cppType - identifier - (TRANSIENT)">Person</span><span class="operator">&gt;::</span><span class="cppStaticMemberFunction - identifier - (TRANSIENT)">deserialize</span><span class="operator">(</span><span class="cppLocalVariable - identifier - (TRANSIENT)">p</span><span class="operator">);</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppNamespace - identifier - (TRANSIENT)">std</span><span class="operator">::</span><span class="cppGlobalVariable - identifier - (TRANSIENT)">cout</span>&nbsp;<span class="cppOperator - operator - (TRANSIENT)">&lt;&lt;</span>&nbsp;<span class="cppNamespace - identifier - (TRANSIENT)">std</span><span class="operator">::</span><span class="cppFunction - identifier - (TRANSIENT)">setw</span><span class="operator">(</span><span class="number">4</span><span class="operator">)</span>&nbsp;<span class="cppOperator - operator - (TRANSIENT)">&lt;&lt;</span>&nbsp;<span class="cppLocalVariable - identifier - (TRANSIENT)">j</span>&nbsp;<span class="cppMemberOperator - operator - (TRANSIENT)">&lt;&lt;</span>&nbsp;<span class="cppNamespace - identifier - (TRANSIENT)">std</span><span class="operator">::</span><span class="cppFunctionTemplate - identifier - (TRANSIENT)">endl</span><span class="operator">;</span>

&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppType - identifier - (TRANSIENT)">Person</span>&nbsp;<span class="cppLocalVariable - identifier - (TRANSIENT)">p2</span><span class="operator">;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppType - identifier - (TRANSIENT)">ClassMetaInfo</span><span class="operator">&lt;</span><span class="cppType - identifier - (TRANSIENT)">Person</span><span class="operator">&gt;::</span><span class="cppStaticMemberFunction - identifier - (TRANSIENT)">serialize</span><span class="operator">(</span><span class="cppLocalVariable - identifier - (TRANSIENT)">p2</span><span class="operator">,</span>&nbsp;<span class="cppLocalVariable - identifier - (TRANSIENT)">j</span><span class="operator">);</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppNamespace - identifier - (TRANSIENT)">std</span><span class="operator">::</span><span class="cppGlobalVariable - identifier - (TRANSIENT)">cout</span>&nbsp;<span class="cppOperator - operator - (TRANSIENT)">&lt;&lt;</span>&nbsp;<span class="string">&quot;Name&nbsp;=&nbsp;&quot;</span>&nbsp;<span class="cppOperator - operator - (TRANSIENT)">&lt;&lt;</span>&nbsp;<span class="cppLocalVariable - identifier - (TRANSIENT)">p2</span><span class="operator">.</span><span class="cppMemberField - identifier - (TRANSIENT)">name</span>&nbsp;<span class="cppOperator - operator - (TRANSIENT)">&lt;&lt;</span>&nbsp;<span class="string">&quot;,&nbsp;age&nbsp;=&nbsp;&quot;</span>&nbsp;<span class="cppMemberOperator - operator - (TRANSIENT)">&lt;&lt;</span>&nbsp;<span class="cppLocalVariable - identifier - (TRANSIENT)">p2</span><span class="operator">.</span><span class="cppMemberField - identifier - (TRANSIENT)">age</span>&nbsp;<span class="cppOperator - operator - (TRANSIENT)">&lt;&lt;</span>&nbsp;<span class="string">&quot;\n&quot;</span><span class="operator">;</span>
<span class="operator">}</span></pre>

<p>Output:</p>

<pre class="console-output">{
    "age": 30,
    "name": "John"
}
Name = John, age = 30</pre>

<p>Okay, that worked!
This system worked well for me, until I understood that if I wanted to add another format (for example, XML), I’d have to add new <code class="highlighter-rouge">toXml</code> / <code class="highlighter-rouge">fromXml</code> virtual functions everywhere. Same for ImGui and anything else. The other problem was the need to call <code class="highlighter-rouge">registerClass</code> function. If I forgot to do it, the “members” map will be empty for the corresponding class. It’s also very hard to implement serializer which will handle nested classes, as shown with <code class="highlighter-rouge">Hero</code> / <code class="highlighter-rouge">Health</code> example shown previously.</p>

<h2 id="implementation-of-metastuff">Implementation of MetaStuff</h2>

<p>Let’s see what had to be changed from a previous meta-library to get this functionality.</p>

<p>First of all, instead of storing members in an <code class="highlighter-rouge">unordered_map</code>, I store them in a <code class="highlighter-rouge">tuple</code>. It looks like this for a <code class="highlighter-rouge">Person</code> class:</p>

<pre class="vs-code"><span class="cppNamespace - identifier - (TRANSIENT)">std</span><span class="operator">::</span><span class="cppType - identifier - (TRANSIENT)">tuple</span><span class="operator">&lt;</span><span class="cppType - identifier - (TRANSIENT)">Member</span><span class="operator">&lt;</span><span class="cppType - identifier - (TRANSIENT)">Person</span><span class="operator">,</span>&nbsp;<span class="cppNamespace - identifier - (TRANSIENT)">std</span><span class="operator">::</span><span class="cppType - identifier - (TRANSIENT)">string</span><span class="operator">&gt;,</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">Member</span><span class="operator">&lt;</span><span class="cppType - identifier - (TRANSIENT)">Person</span><span class="operator">,</span>&nbsp;<span class="keyword">int</span><span class="operator">&gt;&gt;</span>&nbsp;<span class="cppLocalVariable - identifier - (TRANSIENT)">members</span><span class="operator">;</span>
</pre>

<p>With some template magic and Vittorio Romero’s help (see <a href="https://www.youtube.com/watch?v=Za92Tz_g0zQ">this awesome video</a>), I implemented a function which calls some lambda for each member of the tuple. And that’s what <code class="highlighter-rouge">meta::doForAllMembers</code> does: it iterates over all Member objects inside of members tuple and calls lambda passed as the function parameter for each of them. The lambda which is used is a <a href="https://isocpp.org/wiki/faq/cpp14-language#generic-lambdas">generic one</a>, so on each call you get a <code class="highlighter-rouge">Member&lt;Class, T&gt;</code> object without type erasure!</p>

<p>Let’s look at class registration. To register <code class="highlighter-rouge">Person</code> class, you have to write this:</p>

<pre class="vs-code"><span class="keyword">namespace</span>&nbsp;<span class="cppNamespace - identifier - (TRANSIENT)">meta</span>&nbsp;<span class="operator">{</span>

<span class="keyword">template</span>&nbsp;<span class="operator">&lt;&gt;</span>
<span class="keyword">inline</span>&nbsp;<span class="keyword">auto</span>&nbsp;<span class="cppFunction - identifier - (TRANSIENT)">registerMembers</span><span class="operator">&lt;</span><span class="cppType - identifier - (TRANSIENT)">Person</span><span class="operator">&gt;()</span>
<span class="operator">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span>&nbsp;<span class="cppFunction - identifier - (TRANSIENT)">members</span><span class="operator">(</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppFunction - identifier - (TRANSIENT)">member</span><span class="operator">(</span><span class="string">&quot;age&quot;</span><span class="operator">,</span>&nbsp;<span class="operator">&amp;</span><span class="cppType - identifier - (TRANSIENT)">Person</span><span class="operator">::</span><span class="cppMemberField - identifier - (TRANSIENT)">age</span><span class="operator">),</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppFunction - identifier - (TRANSIENT)">member</span><span class="operator">(</span><span class="string">&quot;name&quot;</span><span class="operator">,</span>&nbsp;<span class="operator">&amp;</span><span class="cppType - identifier - (TRANSIENT)">Person</span><span class="operator">::</span><span class="cppMemberField - identifier - (TRANSIENT)">name</span><span class="operator">)</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">);</span>
<span class="operator">}</span>

<span class="operator">}</span>&nbsp;<span class="comment">//&nbsp;end&nbsp;of&nbsp;namespace&nbsp;meta</span></pre>

<p>Note the <code class="highlighter-rouge">auto</code> as the return type. You don’t want to write <code class="highlighter-rouge">std::tuple&lt;Member&lt;Person, std::string&gt;, Member&lt;Person, int&gt;&gt;</code>, the compiler can just deduce it! Imagine the class with 50 members. The return type would be gigantic and the compiler does all the work for you.</p>

<p>Okay, how do we make sure that this <code class="highlighter-rouge">registerMembers&lt;T&gt;</code> function gets called? Simple! I just made class called <a href="https://github.com/eliasdaler/MetaStuff/blob/master/include/detail/MetaHolder.h">MetaHolder</a>, which uses one nice trick. Let’s look at the implementation:</p>

<pre class="vs-code"><span class="preprocessor keyword">#pragma</span>&nbsp;<span class="preprocessor keyword">once</span>

<span class="preprocessor keyword">#include</span>&nbsp;<span class="string">&lt;tuple&gt;</span>

<span class="keyword">namespace</span>&nbsp;<span class="cppNamespace - identifier - (TRANSIENT)">meta</span>
<span class="operator">{</span>
<span class="keyword">namespace</span>&nbsp;<span class="cppNamespace - identifier - (TRANSIENT)">detail</span>
<span class="operator">{</span>

<span class="keyword">template</span>&nbsp;<span class="operator">&lt;</span><span class="keyword">typename</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">T</span><span class="operator">,</span>&nbsp;<span class="keyword">typename</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">TupleType</span><span class="operator">&gt;</span>
<span class="keyword">struct</span>&nbsp;<span class="cppClassTemplate - identifier - (TRANSIENT)">MetaHolder</span>&nbsp;<span class="operator">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">static</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">TupleType</span>&nbsp;<span class="cppStaticMemberField - identifier - (TRANSIENT)">members</span><span class="operator">;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">static</span>&nbsp;<span class="keyword">const</span>&nbsp;<span class="keyword">char</span><span class="operator">*</span>&nbsp;<span class="cppStaticMemberFunction - identifier - (TRANSIENT)">name</span><span class="operator">()</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span>&nbsp;<span class="cppFunctionTemplate - identifier - (TRANSIENT)">registerName</span><span class="operator">&lt;</span><span class="cppType - identifier - (TRANSIENT)">T</span><span class="operator">&gt;();</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">}</span>
<span class="operator">};</span>

<span class="keyword">template</span>&nbsp;<span class="operator">&lt;</span><span class="keyword">typename</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">T</span><span class="operator">,</span>&nbsp;<span class="keyword">typename</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">TupleType</span><span class="operator">&gt;</span>
<span class="cppType - identifier - (TRANSIENT)">TupleType</span>&nbsp;<span class="cppClassTemplate - identifier - (TRANSIENT)">MetaHolder</span><span class="operator">&lt;</span><span class="cppType - identifier - (TRANSIENT)">T</span><span class="operator">,</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">TupleType</span><span class="operator">&gt;::</span><span class="cppStaticMemberField - identifier - (TRANSIENT)">members</span>&nbsp;<span class="operator">=</span>&nbsp;<span class="cppFunctionTemplate - identifier - (TRANSIENT)">registerMembers</span><span class="operator">&lt;</span><span class="cppType - identifier - (TRANSIENT)">T</span><span class="operator">&gt;();</span>

<span class="operator">}</span>&nbsp;<span class="comment">//&nbsp;end&nbsp;of&nbsp;namespace&nbsp;detail</span>
<span class="operator">}</span>&nbsp;<span class="comment">//&nbsp;end&nbsp;of&nbsp;namespace&nbsp;meta</span></pre>

<p>How do we force the instantiation of this template to get generated? Simple, we just use some function from namespace <code class="highlighter-rouge">meta</code>! For example, if you call <code class="highlighter-rouge">meta::doForAllMembers&lt;Person&gt;</code>, it will use <code class="highlighter-rouge">MetaHolder&lt;Person, TupleType&gt;</code> class, which will get compiler to generate this class! Its tuple is initialized by calling <code class="highlighter-rouge">meta::registerMembers&lt;Person&gt;</code>, when the initialization of <code class="highlighter-rouge">members</code> tuple is performed. But wait, how do I get <code class="highlighter-rouge">TupleType</code>? I get it from <code class="highlighter-rouge">registerMember&lt;T&gt;</code> function! So, <code class="highlighter-rouge">TupleType = decltype(registerMembers&lt;T&gt;())</code>.</p>

<p>So, we get a function like this:</p>

<pre class="vs-code"><span class="keyword">template</span>&nbsp;<span class="operator">&lt;</span><span class="keyword">typename</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">Class</span><span class="operator">&gt;</span>
<span class="keyword">const</span>&nbsp;<span class="keyword">auto</span><span class="operator">&amp;</span>&nbsp;<span class="cppFunctionTemplate - identifier - (TRANSIENT)">getMembers</span><span class="operator">()</span>
<span class="operator">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span>&nbsp;<span class="cppNamespace - identifier - (TRANSIENT)">detail</span><span class="operator">::</span><span class="cppType - identifier - (TRANSIENT)">MetaHolder</span><span class="operator">&lt;</span><span class="cppType - identifier - (TRANSIENT)">Class</span><span class="operator">,</span>&nbsp;<span class="keyword">decltype</span><span class="operator">(</span><span class="cppFunctionTemplate - identifier - (TRANSIENT)">registerMembers</span><span class="operator">&lt;</span><span class="cppType - identifier - (TRANSIENT)">Class</span><span class="operator">&gt;())&gt;::</span><span class="identifier">members</span><span class="operator">;</span>
<span class="operator">}</span></pre>

<h3 id="doing-something-for-one-member">Doing something for one member</h3>

<p>Suppose we want to do some things only for member called “name” using MetaStuff:</p>

<pre class="vs-code"><span class="cppNamespace - identifier - (TRANSIENT)">meta</span><span class="operator">::</span><span class="cppFunction - identifier - (TRANSIENT)">doForAllMembers</span><span class="operator">&lt;</span><span class="cppType - identifier - (TRANSIENT)">Person</span><span class="operator">&gt;(</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">[&amp;</span><span class="cppLocalVariable - identifier - (TRANSIENT)">person</span><span class="operator">](</span><span class="keyword">const</span>&nbsp;<span class="keyword">auto</span><span class="operator">&amp;</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">member</span><span class="operator">)</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="operator">(</span><span class="cppParameter - identifier - (TRANSIENT)">member</span><span class="operator">.</span><span class="identifier">getName</span><span class="operator">()</span>&nbsp;<span class="operator">==</span>&nbsp;<span class="string">&quot;name&quot;</span><span class="operator">)</span>&nbsp;<span class="operator">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppNamespace - identifier - (TRANSIENT)">std</span><span class="operator">::</span><span class="cppGlobalVariable - identifier - (TRANSIENT)">cout</span>&nbsp;<span class="cppOperator - operator - (TRANSIENT)">&lt;&lt;</span>&nbsp;<span class="string">&quot;Name&nbsp;starts&nbsp;with&nbsp;&quot;</span>&nbsp;<span class="operator">&lt;&lt;</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">member</span><span class="operator">.</span><span class="identifier">get</span><span class="operator">(</span><span class="identifier">person</span><span class="operator">)[</span><span class="number">0</span><span class="operator">]</span>&nbsp;<span class="operator">&lt;&lt;</span>&nbsp;<span class="string">&#39;\n&#39;</span><span class="operator">;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">}</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">});</span></pre>

<p>Sadly, this doesn’t work! Why? Because lambda gets generated for all registered types! Not just for strings, but for <code class="highlighter-rouge">Person::age</code>, which is an <code class="highlighter-rouge">int</code>. The code <code class="highlighter-rouge">member.get(person)[0]</code> is not valid for <code class="highlighter-rouge">Member</code> whose type is <code class="highlighter-rouge">int</code>, so the compilation fails.</p>

<p>We can use special <code class="highlighter-rouge">doForMember</code> function, which will work well:</p>

<pre class="vs-code"><span class="cppNamespace - identifier - (TRANSIENT)">meta</span><span class="operator">::</span><span class="cppFunctionTemplate - identifier - (TRANSIENT)">doForMember</span><span class="operator">&lt;</span><span class="cppType - identifier - (TRANSIENT)">Person</span><span class="operator">,</span>&nbsp;<span class="cppNamespace - identifier - (TRANSIENT)">std</span><span class="operator">::</span><span class="cppType - identifier - (TRANSIENT)">string</span><span class="operator">&gt;(</span><span class="string">&quot;name&quot;</span><span class="operator">,</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">[&amp;</span><span class="cppLocalVariable - identifier - (TRANSIENT)">person</span><span class="operator">](</span><span class="keyword">const</span>&nbsp;<span class="keyword">auto</span><span class="operator">&amp;</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">member</span><span class="operator">)</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppNamespace - identifier - (TRANSIENT)">std</span><span class="operator">::</span><span class="cppGlobalVariable - identifier - (TRANSIENT)">cout</span>&nbsp;<span class="cppOperator - operator - (TRANSIENT)">&lt;&lt;</span>&nbsp;<span class="string">&quot;Name&nbsp;starts&nbsp;with&nbsp;&quot;</span>&nbsp;<span class="operator">&lt;&lt;</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">member</span><span class="operator">.</span><span class="identifier">get</span><span class="operator">(</span><span class="cppLocalVariable - identifier - (TRANSIENT)">person</span><span class="operator">)[</span><span class="number">0</span><span class="operator">]</span>&nbsp;<span class="operator">&lt;&lt;</span>&nbsp;<span class="string">&#39;\n&#39;</span><span class="operator">;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">});</span></pre>

<p>How does it work? With some SFINAE:</p>

<pre class="vs-code"><span class="keyword">template</span>&nbsp;<span class="operator">&lt;</span><span class="keyword">bool</span>&nbsp;<span class="identifier">Test</span><span class="operator">,</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">typename</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">F</span><span class="operator">,</span>&nbsp;<span class="keyword">typename</span><span class="operator">...</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">Args</span><span class="operator">,</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">typename</span>&nbsp;<span class="operator">=</span>&nbsp;<span class="cppNamespace - identifier - (TRANSIENT)">std</span><span class="operator">::</span><span class="cppType - identifier - (TRANSIENT)">enable_if_t</span><span class="operator">&lt;</span><span class="identifier">Test</span><span class="operator">&gt;&gt;</span>
<span class="keyword">void</span>&nbsp;<span class="cppFunctionTemplate - identifier - (TRANSIENT)">call_if</span><span class="operator">(</span><span class="cppType - identifier - (TRANSIENT)">F</span><span class="operator">&amp;&amp;</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">f</span><span class="operator">,</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">Args</span><span class="operator">&amp;&amp;...</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">args</span><span class="operator">)</span>
<span class="operator">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">f</span><span class="operator">(</span><span class="cppNamespace - identifier - (TRANSIENT)">std</span><span class="operator">::</span><span class="identifier">forward</span><span class="operator">&lt;</span><span class="cppType - identifier - (TRANSIENT)">Args</span><span class="operator">&gt;(</span><span class="cppParameter - identifier - (TRANSIENT)">args</span><span class="operator">)...);</span>
<span class="operator">}</span>

<span class="keyword">template</span>&nbsp;<span class="operator">&lt;</span><span class="keyword">bool</span>&nbsp;<span class="identifier">Test</span><span class="operator">,</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">typename</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">F</span><span class="operator">,</span>&nbsp;<span class="keyword">typename</span><span class="operator">...</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">Args</span><span class="operator">,</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">typename</span><span class="operator">,</span>&nbsp;<span class="keyword">typename</span>&nbsp;<span class="operator">=</span>&nbsp;<span class="keyword">void</span><span class="operator">&gt;</span>
<span class="keyword">void</span>&nbsp;<span class="cppFunctionTemplate - identifier - (TRANSIENT)">call_if</span><span class="operator">(</span><span class="cppType - identifier - (TRANSIENT)">F</span><span class="operator">&amp;&amp;</span>&nbsp;<span class="comment">/*&nbsp;f&nbsp;*/</span><span class="operator">,</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">Args</span><span class="operator">&amp;&amp;...</span>&nbsp;<span class="comment">/*&nbsp;args&nbsp;*/</span><span class="operator">)</span>
<span class="operator">{</span>&nbsp;<span class="comment">/*&nbsp;do&nbsp;nothing&nbsp;*/</span>&nbsp;<span class="operator">}</span></pre>

<p>And then I do this in <code class="highlighter-rouge">doForMember</code>:</p>

<pre class="vs-code"><span class="cppNamespace - identifier - (TRANSIENT)">detail</span><span class="operator">::</span><span class="identifier">call_if</span><span class="operator">&lt;</span><span class="cppNamespace - identifier - (TRANSIENT)">std</span><span class="operator">::</span><span class="cppType - identifier - (TRANSIENT)">is_same</span><span class="operator">&lt;</span><span class="cppType - identifier - (TRANSIENT)">MemberT</span><span class="operator">,</span>&nbsp;<span class="cppType - identifier - (TRANSIENT)">T</span><span class="operator">&gt;::</span><span class="identifier">value</span><span class="operator">&gt;(</span><span class="cppNamespace - identifier - (TRANSIENT)">std</span><span class="operator">::</span><span class="identifier">forward</span><span class="operator">&lt;</span><span class="cppType - identifier - (TRANSIENT)">F</span><span class="operator">&gt;(</span><span class="cppParameter - identifier - (TRANSIENT)">f</span><span class="operator">),</span>&nbsp;<span class="cppParameter - identifier - (TRANSIENT)">member</span><span class="operator">);</span>
</pre>

<p>If <code class="highlighter-rouge">std::is_same</code> returns <code class="highlighter-rouge">true</code>, then <code class="highlighter-rouge">call_if</code> with function call gets generated, otherwise <code class="highlighter-rouge">call_if</code> function will be empty. Remember that “f” is most likely to be generic lambda, so if it doesn’t get called with some argument, then template instantiation for this type is not generated and everything works as expected.</p>

<h2 id="conclusion">Conclusion</h2>

<p>And that’s mostly how MetaStuff works! The library is a bit more complicated than that, because it lets you register classes without default constructors, register getters and setters and more.</p>

<p>The library is still very simple and needs much more work on it. But it’s certainly one of the hardest things I’ve ever written and I’m very proud of it. I’ve learned a lot about templates, and I hope you did too. Maybe this article even will inspire you to write your own library or start using MetaStuff for you projects.</p>

<p>Thank you for reading!</p>

    <hr />
    <p>Follow me on twitter <a href="https://twitter.com/EliasDaler">@EliasDaler</a> to not miss the new stuff!</p>
  </div>

</article>
<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        
        s.src = '//eliasdaler-github-io.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>

  </body>
</html>
